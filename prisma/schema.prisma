generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String                 @id @default(cuid())
  email                   String                 @unique
  name                    String
  phone                   String?
  password                String?
  emailVerified           DateTime?
  phoneVerified           DateTime?
  preferredLanguage       String                 @default("es")
  timezone                String                 @default("Europe/Madrid")
  role                    String                 @default("HOST")
  status                  String                 @default("PENDING")
  subscription            String?
  trialStartedAt          DateTime?
  trialEndsAt             DateTime?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  lastLoginAt             DateTime?
  avatar                  String?
  companyName             String?
  billingAddress          String?
  billingCity             String?
  billingCountry          String?
  billingPostalCode       String?
  vatNumber               String?
  referralCode            String?                @unique
  referredBy              String?
  affiliateCommission     Decimal                @default(0)
  createdBy               String?
  isActive                Boolean                @default(true)
  isAdmin                 Boolean                @default(false)
  notes                   String?
  notificationPreferences Json?                  @default("{}")
  onboardingCompletedAt   DateTime?
  academyEnrolledAt       DateTime?
  academyPoints           Int                    @default(0)
  academyStreak           Int                    @default(0)
  lastAcademyActivityAt   DateTime?
  username                String?                @unique
  academyProgress         AcademyProgress[]
  quizAttempts            QuizAttempt[]
  referralTransactions    AffiliateTransaction[] @relation("AffiliateReferred")
  referredUsers           AffiliateTransaction[] @relation("AffiliateReferrer")
  billingInfo             BillingInfo?
  billingUnitGroups       BillingUnitGroup[]
  billingUnits            BillingUnit[]
  callLogs                CallLog[]
  clientInvoices          ClientInvoice[]
  couponUses              CouponUse[]            @relation("UserCouponUses")
  journeyStages           CustomerJourneyStage[]
  emailChangeTokens       EmailChangeToken[]
  emailEvents             EmailEvent[]
  assignedErrorReports    ErrorReport[]          @relation("ErrorReportAssignee")
  faqSubmissions          FaqSubmission[]
  gmailIntegration        GmailIntegration?
  guests                  Guest[]
  hostProfileTests        HostProfileTest[]
  importTemplates         ImportTemplate[]
  invoices                Invoice[]
  liquidations            Liquidation[]
  mediaItems              MediaLibrary[]
  notifications           Notification[]
  organization_members    organization_members[]
  passwordChangeTokens    PasswordChangeToken[]
  properties              Property[]
  propertyExpenses        PropertyExpense[]
  propertyOwners          PropertyOwner[]
  propertySets            PropertySet[]
  propertyViews           PropertyView[]         @relation("HostPropertyViews")
  reservationImports      ReservationImport[]
  reservationPayments     ReservationPayment[]
  managedReservations     Reservation[]
  subscriptionRequests    SubscriptionRequest[]  @relation("UserSubscriptionRequests")
  trackingEvents          TrackingEvent[]        @relation("UserTrackingEvents")
  achievements            UserAchievement[]
  inspirationState        UserInspirationState?
  invoiceConfig           UserInvoiceConfig?
  modules                 UserModule[]
  userNotes               UserNote[]
  subscriptions           UserSubscription[]
  creator                 User?                  @relation("UserCreatedBy", fields: [createdBy], references: [id])
  createdUsers            User[]                 @relation("UserCreatedBy")
  moderatedComments       ZoneComment[]          @relation("CommentModerator")
  zoneViews               ZoneView[]             @relation("HostZoneViews")
  apiKeys                 ApiKey[]

  @@map("users")
}

model UserModule {
  id                   String            @id @default(cuid())
  userId               String
  moduleType           ModuleType
  status               String            @default("ACTIVE")
  isActive             Boolean           @default(true)
  activatedAt          DateTime          @default(now())
  expiresAt            DateTime?
  canceledAt           DateTime?
  stripeSubscriptionId String?           @unique
  subscriptionPlanId   String?
  trialEndsAt          DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  trialStartedAt       DateTime?
  subscriptionPlan     SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  user                 User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleType])
  @@index([userId, status])
  @@map("user_modules")
}

model BillingInfo {
  id               String   @id @default(cuid())
  userId           String   @unique
  entityType       String
  email            String
  phone            String
  address          String
  city             String
  postalCode       String
  country          String
  companyName      String?
  companyTaxId     String?
  tradeName        String?
  taxId            String?
  businessActivity String?
  firstName        String?
  lastName         String?
  nationalId       String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("billing_info")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
  @@map("email_verification_tokens")
}

model PropertySet {
  id                  String     @id @default(cuid())
  hostId              String
  name                String
  description         String
  street              String
  city                String
  state               String
  country             String
  postalCode          String
  type                String
  profileImage        String?
  hostContactName     String
  hostContactPhone    String
  hostContactEmail    String
  hostContactLanguage String     @default("es")
  hostContactPhoto    String?
  status              String     @default("DRAFT")
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  deletedAt           DateTime?
  properties          Property[]
  host                User       @relation(fields: [hostId], references: [id], onDelete: Cascade)

  @@map("property_sets")
}

model Property {
  id                      String                 @id @default(cuid())
  hostId                  String
  organizationId          String?
  buildingId              String?
  propertySetId           String?
  name                    String
  description             String
  street                  String
  city                    String
  state                   String
  country                 String
  postalCode              String
  type                    String
  bedrooms                Int
  bathrooms               Int
  maxGuests               Int
  squareMeters            Int?
  defaultLanguages        Json                   @default("[\"es\", \"en\"]")
  isPublished             Boolean                @default(false)
  profileImage            String?
  hostContactName         String
  hostContactPhone        String
  hostContactEmail        String
  hostContactLanguage     String                 @default("es")
  hostContactPhoto        String?
  status                  String                 @default("DRAFT")
  trialStartsAt           DateTime?
  trialEndsAt             DateTime?
  trialNotified24h        Boolean                @default(false)
  trialNotified6h         Boolean                @default(false)
  trialNotified1h         Boolean                @default(false)
  subscriptionEndsAt      DateTime?
  lastPaymentDate         DateTime?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  deletedAt               DateTime?
  publishedAt             DateTime?
  slug                    String?                @unique
  propertyCode            String?                @unique
  descriptionTranslations Json?
  nameTranslations        Json?
  trialNotified3d         Boolean                @default(false)
  isDemoPreview           Boolean                @default(false)
  demoExpiresAt           DateTime?
  demoLeadId              String?
  announcements           Announcement[]
  chatbotConversations    ChatbotConversation[]
  clientInvoices          ClientInvoice[]
  buildings               buildings?             @relation(fields: [buildingId], references: [id])
  host                    User                   @relation(fields: [hostId], references: [id], onDelete: Cascade)
  organizations           organizations?         @relation(fields: [organizationId], references: [id])
  propertySet             PropertySet?           @relation(fields: [propertySetId], references: [id])
  analytics               PropertyAnalytics?
  billingConfig           PropertyBillingConfig?
  propertyRatings         PropertyRating[]
  propertyViews           PropertyView[]
  reviews                 Review[]
  trackingEvents          TrackingEvent[]
  zoneViews               ZoneView[]             @relation("PropertyZoneViews")
  zones                   Zone[]
  guidebookDeliveries     GuidebookDelivery[]
  externalMappings        PropertyExternalMapping[]

  @@index([slug])
  @@map("properties")
}

model Zone {
  id                  String          @id @default(cuid())
  propertyId          String?
  organizationId      String?
  buildingId          String?
  name                Json
  description         Json?
  icon                String
  color               String?
  qrCode              String          @unique
  accessCode          String          @unique
  whatsappEnabled     Boolean         @default(true)
  errorReportsEnabled Boolean         @default(true)
  commentsEnabled     Boolean         @default(true)
  ratingsEnabled      Boolean         @default(true)
  status              String          @default("DRAFT")
  isPublished         Boolean         @default(false)
  viewCount           Int             @default(0)
  lastViewedAt        DateTime?
  avgRating           Float           @default(0)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  publishedAt         DateTime?
  slug                String?
  order                  Int                      @default(0)
  type                   String                   @default("STANDARD")
  recommendationCategory String?
  errorReports           ErrorReport[]
  recommendations        Recommendation[]
  reviews                Review[]
  steps                  Step[]
  trackingEvents         TrackingEvent[]
  analytics              ZoneAnalytics?
  comments               ZoneComment[]
  ratings                ZoneRating[]
  zoneViews              ZoneView[]               @relation("ZoneViews")
  buildings              buildings?               @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  organizations          organizations?           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  property               Property?                @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, slug])
  @@index([propertyId, status])
  @@index([qrCode])
  @@index([slug])
  @@map("zones")
}

model Step {
  id          String   @id @default(cuid())
  zoneId      String
  type        String
  title       Json
  content     Json
  order       Int      @default(0)
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  zones       Zone     @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId, order])
  @@map("steps")
}

model ZoneComment {
  id               String    @id @default(cuid())
  zoneId           String
  text             String
  rating           Int
  language         String
  guestName        String?
  guestCountry     String?
  guestLanguage    String
  status           String    @default("PENDING")
  moderatedAt      DateTime?
  moderatedBy      String?
  moderationReason String?
  helpfulVotes     Int       @default(0)
  reportedCount    Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  ipAddress        String?
  userAgent        String?
  moderator        User?     @relation("CommentModerator", fields: [moderatedBy], references: [id])
  zone             Zone      @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId, status])
  @@map("zone_comments")
}

model ErrorReport {
  id               String    @id @default(cuid())
  zoneId           String
  title            String
  description      String
  category         String
  severity         String
  affectedStep     String?
  userAgent        String?
  browserInfo      String?
  deviceType       String
  language         String
  reporterEmail    String?
  reporterLanguage String
  status           String    @default("PENDING")
  priority         String    @default("MEDIUM")
  assignedTo       String?
  hostResponse     String?
  resolutionNotes  String?
  resolvedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  assignee         User?     @relation("ErrorReportAssignee", fields: [assignedTo], references: [id])
  zone             Zone      @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
  @@map("error_reports")
}

model ZoneRating {
  id                     String   @id @default(cuid())
  zoneId                 String
  overallRating          Int
  clarity                Int
  completeness           Int
  helpfulness            Int
  upToDate               Int
  feedback               String?
  improvementSuggestions String?
  language               String
  guestAgeRange          String?
  guestCountry           String?
  guestTravelType        String?
  createdAt              DateTime @default(now())
  ipAddress              String?
  visibleToHost          Boolean  @default(true)
  visibleToGuests        Boolean  @default(false)
  zone                   Zone     @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId, createdAt])
  @@map("zone_ratings")
}

model PropertyAnalytics {
  id                 String    @id @default(cuid())
  propertyId         String    @unique
  totalViews         Int       @default(0)
  uniqueVisitors     Int       @default(0)
  avgSessionDuration Int       @default(0)
  overallRating      Float     @default(0)
  totalRatings       Int       @default(0)
  improvementScore   Int       @default(0)
  whatsappClicks     Int       @default(0)
  errorReportsCount  Int       @default(0)
  commentsCount      Int       @default(0)
  lastCalculatedAt   DateTime  @default(now())
  lastViewedAt       DateTime?
  zoneViews          Int       @default(0)
  property           Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("property_analytics")
}

model DailyStats {
  id                 String   @id @default(cuid())
  propertyId         String
  date               DateTime
  views              Int      @default(0)
  uniqueVisitors     Int      @default(0)
  avgSessionDuration Int      @default(0)
  whatsappClicks     Int      @default(0)
  errorReports       Int      @default(0)
  newComments        Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([propertyId, date])
  @@index([propertyId, date])
  @@map("daily_stats")
}

model TrackingEvent {
  id         String   @id @default(cuid())
  type       String
  propertyId String
  zoneId     String?
  stepId     String?
  userId     String?
  sessionId  String?
  metadata   Json?
  timestamp  DateTime @default(now())
  userAgent  String?
  ipAddress  String?
  duration   Int?
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user       User?    @relation("UserTrackingEvents", fields: [userId], references: [id])
  zone       Zone?    @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([propertyId, type, timestamp])
  @@index([zoneId, type, timestamp])
  @@index([sessionId, timestamp])
  @@map("tracking_events")
}

model ZoneAnalytics {
  id                String    @id @default(cuid())
  zoneId            String    @unique
  totalViews        Int       @default(0)
  uniqueVisitors    Int       @default(0)
  avgTimeSpent      Int       @default(0)
  completionRate    Float     @default(0)
  avgStepsCompleted Float     @default(0)
  totalCompletions  Int       @default(0)
  avgRating         Float     @default(0)
  totalRatings      Int       @default(0)
  timeSavedMinutes  Int       @default(0)
  lastCalculatedAt  DateTime  @default(now())
  lastViewedAt      DateTime?
  totalTimeSpent    Int       @default(0)
  zone              Zone      @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@map("zone_analytics")
}

model buildings {
  id             String        @id
  organizationId String
  name           String
  street         String
  city           String
  state          String
  country        String
  postalCode     String
  latitude       Float?
  longitude      Float?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  organizations  organizations @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  properties     Property[]
  zones          Zone[]
}

model organization_members {
  id             String        @id
  organizationId String
  userId         String
  role           String
  permissions    Json          @default("[]")
  joinedAt       DateTime      @default(now())
  organizations  organizations @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
}

model organizations {
  id                   String                 @id
  name                 String
  type                 String
  description          String?
  website              String?
  logo                 String?
  brandColorPrimary    String?
  brandColorSecondary  String?
  customDomain         String?                @unique
  defaultLanguages     Json                   @default("[\"es\", \"en\"]")
  timezone             String                 @default("Europe/Madrid")
  status               String                 @default("ACTIVE")
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  buildings            buildings[]
  organization_members organization_members[]
  properties           Property[]
  zones                Zone[]
}

model UserInspirationState {
  id                   String   @id @default(cuid())
  userId               String   @unique
  dismissedZones       Json     @default("[]")
  createdZones         Json     @default("[]")
  lastShownInspiration String?
  showInspirations     Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_inspiration_states")
}

model SubscriptionPlan {
  id                 String                @id @default(cuid())
  code               String                @unique
  name               String
  description        String?
  priceMonthly       Decimal               @map("price_monthly")
  priceSemestral     Decimal?              @map("price_semestral")
  priceYearly        Decimal?              @map("price_yearly")
  aiMessagesIncluded Int                   @default(0) @map("ai_messages_included")
  maxProperties      Int                   @default(1) @map("max_properties")
  features           Json                  @default("[]")
  isActive           Boolean               @default(true) @map("is_active")
  isVisibleInUI      Boolean               @default(true) @map("is_visible_in_ui")
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  requests           SubscriptionRequest[] @relation("PlanRequests")
  userModules        UserModule[]
  subscriptions      UserSubscription[]

  @@map("subscription_plans")
}

model UserSubscription {
  id                   String            @id @default(cuid())
  userId               String            @map("user_id")
  planId               String?           @map("plan_id")
  customPlanId         String?           @map("custom_plan_id")
  status               String
  customPrice          Decimal?          @map("custom_price")
  discountPercentage   Decimal?          @default(0) @map("discount_percentage")
  discountReason       String?           @map("discount_reason")
  startDate            DateTime          @map("start_date")
  endDate              DateTime?         @map("end_date")
  notes                String?
  createdBy            String?           @map("created_by")
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")
  cancelAtPeriodEnd    Boolean           @default(false) @map("cancel_at_period_end")
  cancelReason         String?           @map("cancel_reason")
  canceledAt           DateTime?         @map("canceled_at")
  stripeSubscriptionId String?           @unique @map("stripe_subscription_id")
  invoices             Invoice[]
  customPlan           CustomPlan?       @relation(fields: [customPlanId], references: [id])
  plan                 SubscriptionPlan? @relation(fields: [planId], references: [id])
  user                 User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_subscriptions")
}

model Invoice {
  id               String            @id @default(cuid())
  userId           String            @map("user_id")
  subscriptionId   String?           @map("subscription_id")
  invoiceNumber    String            @unique @map("invoice_number")
  amount           Decimal
  discountAmount   Decimal           @default(0) @map("discount_amount")
  finalAmount      Decimal           @map("final_amount")
  status           String
  paymentMethod    String?           @map("payment_method")
  paymentReference String?           @map("payment_reference")
  dueDate          DateTime          @map("due_date")
  paidDate         DateTime?         @map("paid_date")
  notes            String?
  createdBy        String?           @map("created_by")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  subscription     UserSubscription? @relation(fields: [subscriptionId], references: [id])
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

model AdminActivityLog {
  id          String   @id @default(cuid())
  action      String
  targetType  String?  @map("target_type")
  targetId    String?  @map("target_id")
  description String?
  metadata    Json?    @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  adminId     String   @map("admin_id")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  admin       Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, createdAt])
  @@map("admin_activity_log")
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String   @default("string")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model MediaLibrary {
  id           String    @id @default(cuid())
  userId       String
  type         String
  url          String
  thumbnailUrl String?
  filename     String
  originalName String
  mimeType     String
  size         Int
  duration     Int?
  width        Int?
  height       Int?
  hash         String
  tags         String[]  @default([])
  usageCount   Int       @default(0)
  isPublic     Boolean   @default(false)
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastUsedAt   DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, hash])
  @@index([userId, type])
  @@index([hash])
  @@map("media_library")
}

model PropertyRating {
  id         String    @id @default(cuid())
  propertyId String
  rating     Int
  comment    String?
  guestId    String
  guestIp    String?
  status     String    @default("PENDING")
  createdAt  DateTime  @default(now())
  reviewedAt DateTime?
  property   Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, status])
  @@index([guestId])
  @@map("property_ratings")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  data      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

model Review {
  id              String    @id @default(cuid())
  propertyId      String
  zoneId          String?
  rating          Int
  comment         String?
  userName        String    @default("Usuario an√≥nimo")
  userEmail       String?
  reviewType      String
  isPublic        Boolean   @default(false)
  isApproved      Boolean   @default(false)
  hostResponse    String?
  hostRespondedAt DateTime?
  emailSent       Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  zone            Zone?     @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([propertyId, isPublic])
  @@index([zoneId, isPublic])
  @@index([createdAt])
  @@index([isApproved, isPublic])
  @@map("reviews")
}

model Announcement {
  id         String    @id @default(cuid())
  propertyId String
  category   String
  priority   String    @default("NORMAL")
  isActive   Boolean   @default(true)
  startDate  DateTime?
  endDate    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  title      Json
  message    Json
  property   Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, isActive])
  @@index([startDate, endDate])
  @@map("announcements")
}

model PropertyView {
  id           String   @id @default(cuid())
  propertyId   String
  hostId       String
  visitorIp    String
  userAgent    String?
  referrer     String?
  language     String   @default("es")
  timezone     String   @default("UTC")
  screenWidth  Int?
  screenHeight Int?
  viewedAt     DateTime @default(now())
  host         User     @relation("HostPropertyViews", fields: [hostId], references: [id], onDelete: Cascade)
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, viewedAt])
  @@index([hostId, viewedAt])
  @@index([visitorIp])
  @@map("property_views")
}

model ZoneView {
  id           String   @id @default(cuid())
  zoneId       String
  propertyId   String
  hostId       String
  visitorIp    String
  userAgent    String?
  referrer     String?
  language     String   @default("es")
  timezone     String   @default("UTC")
  screenWidth  Int?
  screenHeight Int?
  timeSpent    Int      @default(0)
  viewedAt     DateTime @default(now())
  isHostView   Boolean  @default(false)
  host         User     @relation("HostZoneViews", fields: [hostId], references: [id], onDelete: Cascade)
  property     Property @relation("PropertyZoneViews", fields: [propertyId], references: [id], onDelete: Cascade)
  zone         Zone     @relation("ZoneViews", fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId, viewedAt])
  @@index([propertyId, viewedAt])
  @@index([hostId, viewedAt])
  @@index([visitorIp])
  @@index([isHostView])
  @@map("zone_views")
}

model Admin {
  id           String             @id @default(cuid())
  email        String             @unique
  name         String
  password     String
  role         String             @default("ADMIN")
  isActive     Boolean            @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  permissions  Json               @default("[]")
  activityLogs AdminActivityLog[]
  auditLogs    AdminAuditLog[]
  callLogs     CallLog[]
  userNotes    UserNote[]

  @@map("admins")
}

model CallLog {
  id               String    @id @default(cuid())
  userId           String
  adminId          String
  type             String
  duration         Int?
  reason           String
  resolution       String?
  notes            String?
  followUpRequired Boolean   @default(false)
  followUpDate     DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  admin            Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([adminId])
  @@index([createdAt])
  @@map("call_logs")
}

model UserNote {
  id        String   @id @default(cuid())
  userId    String
  adminId   String
  type      String   @default("GENERAL")
  priority  String   @default("MEDIUM")
  title     String
  content   String
  isPrivate Boolean  @default(false)
  tags      String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([adminId])
  @@index([createdAt])
  @@map("user_notes")
}

model AffiliateTransaction {
  id             String    @id @default(cuid())
  referrerId     String    @map("referrer_id")
  referredUserId String    @map("referred_user_id")
  type           String
  amount         Decimal
  status         String    @default("PENDING")
  description    String?
  paidAt         DateTime? @map("paid_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  referredUser   User      @relation("AffiliateReferred", fields: [referredUserId], references: [id])
  referrer       User      @relation("AffiliateReferrer", fields: [referrerId], references: [id])

  @@index([referrerId])
  @@index([referredUserId])
  @@map("affiliate_transactions")
}

model Coupon {
  id                String      @id @default(cuid())
  code              String      @unique
  name              String
  description       String?
  type              String
  discountPercent   Int?
  discountAmount    Decimal?
  freeMonths        Int?
  maxUses           Int?
  usedCount         Int         @default(0)
  maxUsesPerUser    Int         @default(1)
  validFrom         DateTime    @default(now())
  validUntil        DateTime?
  minAmount         Decimal?
  minDuration       Int?
  applicableToPlans String[]
  isActive          Boolean     @default(true)
  isPublic          Boolean     @default(false)
  campaignSource    String?
  createdBy         String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  applicableModule  ModuleType?
  uses              CouponUse[]

  @@index([code])
  @@index([validFrom, validUntil])
  @@index([campaignSource])
  @@index([applicableModule])
  @@map("coupons")
}

model CouponUse {
  id              String   @id @default(cuid())
  couponId        String   @map("coupon_id")
  userId          String   @map("user_id")
  orderId         String?  @map("order_id")
  discountApplied Decimal
  originalAmount  Decimal
  finalAmount     Decimal
  createdAt       DateTime @default(now())
  coupon          Coupon   @relation(fields: [couponId], references: [id])
  user            User     @relation("UserCouponUses", fields: [userId], references: [id])

  @@index([couponId])
  @@index([userId])
  @@map("coupon_uses")
}

model CustomPlan {
  id                  String                @id @default(cuid())
  name                String
  description         String?
  pricePerProperty    Decimal
  minProperties       Int                   @default(1)
  maxProperties       Int?
  features            Json                  @default("[]")
  restrictions        Json                  @default("{}")
  isForHotels         Boolean               @default(false)
  maxZonesPerProperty Int?
  isActive            Boolean               @default(true)
  requiresApproval    Boolean               @default(false)
  createdBy           String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  requests            SubscriptionRequest[] @relation("CustomPlanRequests")
  subscriptions       UserSubscription[]

  @@map("custom_plans")
}

model EmailChangeToken {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  oldEmail    String    @map("old_email")
  newEmail    String    @map("new_email")
  token       String    @unique
  expiresAt   DateTime  @map("expires_at")
  confirmedAt DateTime? @map("confirmed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, newEmail])
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("email_change_tokens")
}

model PasswordChangeToken {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  newPasswordHash String    @map("new_password_hash")
  token           String    @unique
  expiresAt       DateTime  @map("expires_at")
  confirmedAt     DateTime? @map("confirmed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_change_tokens")
}

model PricingTier {
  id               String   @id @default(cuid())
  minProperties    Int      @map("min_properties")
  maxProperties    Int?     @map("max_properties")
  pricePerProperty Decimal  @map("price_per_property")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([minProperties])
  @@index([maxProperties])
  @@map("pricing_tiers")
}

model SubscriptionRequest {
  id               String            @id @default(cuid())
  userId           String            @map("user_id")
  planId           String?           @map("plan_id")
  customPlanId     String?           @map("custom_plan_id")
  requestType      String
  propertiesCount  Int?              @map("properties_count")
  totalAmount      Decimal           @map("total_amount")
  status           String            @default("PENDING")
  paymentMethod    String?           @map("payment_method")
  paymentReference String?           @map("payment_reference")
  paymentProofUrl  String?           @map("payment_proof_url")
  requestedAt      DateTime          @default(now()) @map("requested_at")
  paidAt           DateTime?         @map("paid_at")
  approvedAt       DateTime?         @map("approved_at")
  rejectedAt       DateTime?         @map("rejected_at")
  reviewedBy       String?           @map("reviewed_by")
  adminNotes       String?           @map("admin_notes")
  metadata         Json?
  moduleType       ModuleType?       @map("module_type")
  customPlan       CustomPlan?       @relation("CustomPlanRequests", fields: [customPlanId], references: [id])
  plan             SubscriptionPlan? @relation("PlanRequests", fields: [planId], references: [id])
  user             User              @relation("UserSubscriptionRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
  @@map("subscription_requests")
}

model BlogPost {
  id              String        @id @default(cuid())
  slug            String        @unique
  title           String
  subtitle        String?
  excerpt         String
  content         String
  coverImage      String?
  coverImageAlt   String?
  category        BlogCategory
  tags            String[]
  featured        Boolean       @default(false)
  metaTitle       String?
  metaDescription String?
  keywords        String[]
  status          BlogStatus    @default(DRAFT)
  publishedAt     DateTime?
  scheduledFor    DateTime?
  authorId        String
  authorName      String
  views           Int           @default(0)
  uniqueViews     Int           @default(0)
  readTime        Int           @default(5)
  likes           Int           @default(0)
  shares          Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  authorImage     String?
  comments        BlogComment[]

  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([publishedAt])
  @@index([featured])
  @@index([status, category, publishedAt])
  @@index([status, publishedAt])
  @@map("blog_posts")
}

model BlogComment {
  id                 String        @id @default(cuid())
  postId             String
  parentId           String?
  authorName         String
  authorEmail        String
  content            String
  status             CommentStatus @default(PENDING_VERIFICATION)
  likes              Int           @default(0)
  isAuthor           Boolean       @default(false)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  emailVerified      Boolean       @default(false)
  verificationSentAt DateTime?
  verificationToken  String?       @unique
  verifiedAt         DateTime?
  parent             BlogComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies            BlogComment[] @relation("CommentReplies")
  post               BlogPost      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([parentId])
  @@index([status])
  @@index([createdAt])
  @@index([verificationToken])
  @@map("blog_comments")
}

model Lead {
  id               String                 @id @default(cuid())
  name             String
  email            String
  source           String
  userAgent        String?
  ipAddress        String?
  metadata         Json?
  createdAt        DateTime               @default(now())
  funnelCurrentDay Int?                   @default(0) @map("funnel_current_day")
  funnelStartedAt  DateTime?              @map("funnel_started_at")
  funnelTheme      String?                @map("funnel_theme")
  propertyCount    String?                @map("property_count")
  journeyStages    CustomerJourneyStage[]
  emailEvents      EmailEvent[]

  @@index([email])
  @@index([source])
  @@index([createdAt])
  @@index([funnelTheme])
  @@map("leads")
}

model CustomerJourneyStage {
  id        String       @id @default(cuid())
  leadId    String?      @map("lead_id")
  userId    String?      @map("user_id")
  email     String
  stage     JourneyStage
  score     Int          @default(0)
  enteredAt DateTime     @default(now()) @map("entered_at")
  exitedAt  DateTime?    @map("exited_at")
  metadata  Json?
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  lead      Lead?        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, stage])
  @@index([leadId])
  @@index([userId])
  @@index([stage, enteredAt])
  @@map("customer_journey_stages")
}

model EmailEvent {
  id           String         @id @default(cuid())
  leadId       String?        @map("lead_id")
  userId       String?        @map("user_id")
  email        String
  eventType    EmailEventType
  campaignId   String?        @map("campaign_id")
  templateName String         @map("template_name")
  subject      String
  sentAt       DateTime       @default(now()) @map("sent_at")
  deliveredAt  DateTime?      @map("delivered_at")
  openedAt     DateTime?      @map("opened_at")
  clickedAt    DateTime?      @map("clicked_at")
  bouncedAt    DateTime?      @map("bounced_at")
  clickedUrl   String?        @map("clicked_url")
  bounceReason String?        @map("bounce_reason")
  metadata     Json?
  campaign     EmailCampaign? @relation(fields: [campaignId], references: [id])
  lead         Lead?          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user         User?          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, eventType])
  @@index([leadId])
  @@index([userId])
  @@index([campaignId])
  @@index([sentAt])
  @@map("email_events")
}

model EmailCampaign {
  id            String         @id @default(cuid())
  name          String
  description   String?
  trigger       EmailTrigger
  triggerStages JourneyStage[]
  templateName  String         @map("template_name")
  subject       String
  fromName      String         @default("Itineramio") @map("from_name")
  fromEmail     String         @default("hola@itineramio.com") @map("from_email")
  delayMinutes  Int            @default(0) @map("delay_minutes")
  isActive      Boolean        @default(true) @map("is_active")
  sentCount     Int            @default(0) @map("sent_count")
  openedCount   Int            @default(0) @map("opened_count")
  clickedCount  Int            @default(0) @map("clicked_count")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  emailEvents   EmailEvent[]

  @@map("email_campaigns")
}

model Course {
  id              String               @id @default(cuid())
  title           String
  slug            String               @unique
  description     String
  coverImage      String?
  difficulty      String               @default("INTERMEDIATE")
  duration        Int
  passingScore    Int                  @default(80)
  published       Boolean              @default(false)
  enrollmentCount Int                  @default(0)
  isPaid          Boolean              @default(false)
  price           Decimal              @default(0)
  paymentMethods  String[]             @default([])
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  modules         Module[]
  payments        AcademyPayment[]
  reviews         AcademyReview[]
  diplomas        AcademyUserDiploma[]

  @@map("academy_courses")
}

model Module {
  id            String    @id @default(cuid())
  courseId      String
  title         String
  slug          String
  description   String
  icon          String?
  order         Int
  unlockDate    DateTime?
  estimatedTime Int
  published     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lessons       Lesson[]
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  quiz          Quiz?

  @@unique([courseId, slug])
  @@map("academy_modules")
}

model Lesson {
  id              String                @id @default(cuid())
  moduleId        String
  title           String
  slug            String
  description     String?
  slides          Json
  coverImage      String?
  videoUrl        String?
  duration        Int
  order           Int
  points          Int                   @default(10)
  published       Boolean               @default(false)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  module          Module                @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress        AcademyProgress[]
  academyProgress AcademyUserProgress[]

  @@unique([moduleId, slug])
  @@map("academy_lessons")
}

model Quiz {
  id              String                   @id @default(cuid())
  moduleId        String                   @unique
  title           String
  description     String?
  passingScore    Int                      @default(80)
  timeLimit       Int?
  maxAttempts     Int?
  points          Int                      @default(50)
  published       Boolean                  @default(false)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  questions       Question[]
  attempts        QuizAttempt[]
  module          Module                   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  academyAttempts AcademyUserQuizAttempt[]

  @@map("academy_quizzes")
}

model Question {
  id             String                  @id @default(cuid())
  quizId         String
  question       String
  type           String                  @default("MULTIPLE_CHOICE")
  options        Json
  correctAnswer  Int
  explanation    String?
  order          Int
  points         Int                     @default(1)
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  quiz           Quiz                    @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers        QuizAnswer[]
  academyAnswers AcademyUserQuizAnswer[]

  @@map("academy_questions")
}

model QuizAttempt {
  id          String       @id @default(cuid())
  userId      String
  quizId      String
  score       Float
  passed      Boolean
  startedAt   DateTime     @default(now())
  completedAt DateTime?
  timeSpent   Int?
  answers     QuizAnswer[]
  quiz        Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("academy_quiz_attempts")
}

model QuizAnswer {
  id             String      @id @default(cuid())
  attemptId      String
  questionId     String
  selectedAnswer Int
  isCorrect      Boolean
  answeredAt     DateTime    @default(now())
  attempt        QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question       Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@map("academy_quiz_answers")
}

model QuizLead {
  id                       String    @id @default(cuid())
  email                    String
  fullName                 String?
  score                    Int
  level                    String
  answers                  Json
  completedAt              DateTime  @default(now())
  timeElapsed              Int
  converted                Boolean   @default(false)
  academyUserId            String?
  source                   String    @default("QUIZ_PUBLIC")
  userAgent                String?
  ipAddress                String?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  emailVerified            Boolean   @default(false)
  verificationToken        String?   @unique
  verificationTokenExpires DateTime?
  verifiedAt               DateTime?

  @@index([email])
  @@index([completedAt])
  @@index([converted])
  @@index([emailVerified])
  @@index([verificationToken])
  @@map("quiz_leads")
}

model AcademyProgress {
  id             String    @id @default(cuid())
  userId         String
  lessonId       String
  completed      Boolean   @default(false)
  completedAt    DateTime?
  timeSpent      Int       @default(0)
  lastAccessedAt DateTime  @default(now())
  createdAt      DateTime  @default(now())
  lesson         Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("academy_progress")
}

model Achievement {
  id           String                   @id @default(cuid())
  code         String                   @unique
  title        String
  description  String
  icon         String?
  badge        String?
  points       Int                      @default(0)
  rarity       String                   @default("COMMON")
  createdAt    DateTime                 @default(now())
  academyUsers AcademyUserAchievement[]
  users        UserAchievement[]

  @@map("academy_achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model Diploma {
  id               String   @id @default(cuid())
  userId           String
  courseId         String
  fullName         String
  certificateCode  String   @unique
  finalScore       Float
  rank             Int?
  totalStudents    Int?
  completedAt      DateTime @default(now())
  pdfUrl           String?
  sharedToFacebook Boolean  @default(false)
  viewCount        Int      @default(0)
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([courseId])
  @@index([finalScore])
  @@index([completedAt])
  @@map("academy_diplomas")
}

model AcademyUser {
  id                       String                   @id @default(cuid())
  email                    String                   @unique
  password                 String
  fullName                 String
  username                 String?                  @unique
  avatar                   String?
  bio                      String?
  academyPoints            Int                      @default(0)
  academyStreak            Int                      @default(0)
  lastActivityAt           DateTime                 @default(now())
  enrolledAt               DateTime                 @default(now())
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  emailVerificationExpires DateTime?
  emailVerificationToken   String?                  @unique
  emailVerified            Boolean                  @default(false)
  day10EmailSent           Boolean                  @default(false)
  day2EmailSent            Boolean                  @default(false)
  day5EmailSent            Boolean                  @default(false)
  emailClicks              Int                      @default(0)
  emailOpens               Int                      @default(0)
  journeyStage             String                   @default("QUIZ_COMPLETED")
  lastEmailClickedAt       DateTime?
  lastEmailOpenedAt        DateTime?
  quizAnswers              Json?
  quizCompletedAt          DateTime?
  quizLevel                String?
  quizScore                Int?
  tags                     String[]                 @default([])
  welcomeEmailSent         Boolean                  @default(false)
  emailLogs                AcademyEmailLog[]
  payments                 AcademyPayment[]
  reviews                  AcademyReview[]
  achievements             AcademyUserAchievement[]
  diplomas                 AcademyUserDiploma[]
  events                   AcademyUserEvent[]
  progress                 AcademyUserProgress[]
  quizAttempts             AcademyUserQuizAttempt[]

  @@map("academy_users")
}

model AcademyUserProgress {
  id             String      @id @default(cuid())
  userId         String
  lessonId       String
  completed      Boolean     @default(false)
  completedAt    DateTime?
  timeSpent      Int         @default(0)
  lastAccessedAt DateTime    @default(now())
  createdAt      DateTime    @default(now())
  lesson         Lesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user           AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("academy_user_progress")
}

model AcademyUserQuizAttempt {
  id          String                  @id @default(cuid())
  userId      String
  quizId      String
  score       Float
  passed      Boolean
  startedAt   DateTime                @default(now())
  completedAt DateTime?
  timeSpent   Int?
  answers     AcademyUserQuizAnswer[]
  quiz        Quiz                    @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        AcademyUser             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("academy_user_quiz_attempts")
}

model AcademyUserQuizAnswer {
  id             String                 @id @default(cuid())
  attemptId      String
  questionId     String
  selectedAnswer Int
  isCorrect      Boolean
  answeredAt     DateTime               @default(now())
  attempt        AcademyUserQuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question       Question               @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@map("academy_user_quiz_answers")
}

model AcademyUserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("academy_user_achievements")
}

model AcademyUserDiploma {
  id               String      @id @default(cuid())
  userId           String
  courseId         String
  fullName         String
  certificateCode  String      @unique
  finalScore       Float
  rank             Int?
  totalStudents    Int?
  completedAt      DateTime    @default(now())
  pdfUrl           String?
  sharedToFacebook Boolean     @default(false)
  viewCount        Int         @default(0)
  createdAt        DateTime    @default(now())
  course           Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user             AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
  @@index([finalScore])
  @@map("academy_user_diplomas")
}

model AcademyReview {
  id          String      @id @default(cuid())
  userId      String
  courseId    String
  rating      Int
  testimonial String?
  isPublic    Boolean     @default(false)
  isApproved  Boolean     @default(false)
  createdAt   DateTime    @default(now())
  course      Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([courseId, isApproved, isPublic])
  @@map("academy_reviews")
}

model AcademyPayment {
  id              String      @id @default(cuid())
  userId          String
  courseId        String
  amount          Decimal
  method          String
  status          String      @default("pending")
  stripeSessionId String?     @unique
  stripePaymentId String?
  reference       String?
  proofUrl        String?
  paidAt          DateTime?
  createdAt       DateTime    @default(now())
  course          Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user            AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("academy_payments")
}

model AcademyEmailLog {
  id         String      @id @default(cuid())
  userId     String
  emailType  String
  subject    String
  sentAt     DateTime    @default(now())
  opened     Boolean     @default(false)
  openedAt   DateTime?
  clicked    Boolean     @default(false)
  clickedAt  DateTime?
  bounced    Boolean     @default(false)
  complained Boolean     @default(false)
  resendId   String?     @unique
  user       AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([emailType])
  @@index([sentAt])
  @@map("academy_email_logs")
}

model AcademyUserEvent {
  id        String      @id @default(cuid())
  userId    String
  eventType String
  eventData Json?
  createdAt DateTime    @default(now())
  user      AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([eventType])
  @@map("academy_user_events")
}

model KnowledgeCategory {
  id            String              @id @default(cuid())
  name          String              @unique
  slug          String              @unique
  description   String?
  icon          String?
  color         String?
  order         Int                 @default(0)
  parentId      String?
  country       String?
  language      String              @default("es")
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  articles      KnowledgeArticle[]
  parent        KnowledgeCategory?  @relation("SubCategories", fields: [parentId], references: [id])
  subcategories KnowledgeCategory[] @relation("SubCategories")

  @@index([slug])
  @@index([country])
  @@index([order])
  @@map("knowledge_categories")
}

model KnowledgeTag {
  id       String             @id @default(cuid())
  name     String             @unique
  slug     String             @unique
  color    String?
  articles KnowledgeArticle[] @relation("ArticleTags")

  @@index([slug])
  @@map("knowledge_tags")
}

model KnowledgeArticle {
  id                   String            @id @default(cuid())
  slug                 String            @unique
  title                String
  content              String
  excerpt              String?
  metaTitle            String?
  metaDescription      String?
  keywords             String[]          @default([])
  views                Int               @default(0)
  publishedAt          DateTime?
  version              Int               @default(1)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  author               String?
  categoryId           String
  country              String?
  downvotes            Int               @default(0)
  embedding            Json?
  embeddingModel       String?
  language             String            @default("es")
  lastReviewedAt       DateTime?
  previousVersionId    String?
  sourceType           String            @default("MANUAL")
  sourceUrl            String?
  upvotes              Int               @default(0)
  status               String            @default("DRAFT")
  category             KnowledgeCategory @relation(fields: [categoryId], references: [id])
  sources              KnowledgeSource[]
  relatedQuizQuestions QuizQuestion[]
  tags                 KnowledgeTag[]    @relation("ArticleTags")
  chatbotQueries       CerebellumQuery[] @relation("CerebellumQueryToKnowledgeArticle")

  @@index([slug])
  @@index([status])
  @@index([categoryId])
  @@index([country])
  @@index([publishedAt])
  @@map("knowledge_articles")
}

model KnowledgeSource {
  id            String            @id @default(cuid())
  articleId     String?
  url           String?
  title         String
  type          String
  description   String?
  rawContent    String?
  extractedAt   DateTime?
  author        String?
  publishedDate DateTime?
  language      String            @default("es")
  country       String?
  status        String            @default("PENDING")
  errorMessage  String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  article       KnowledgeArticle? @relation(fields: [articleId], references: [id])

  @@index([url])
  @@index([status])
  @@index([type])
  @@map("knowledge_sources")
}

model QuizQuestion {
  id               String            @id @default(cuid())
  question         String
  category         String
  difficulty       String
  points           Int               @default(1)
  type             String
  options          Json
  explanation      String?
  relatedArticleId String?
  isActive         Boolean           @default(true)
  order            Int               @default(0)
  timesAsked       Int               @default(0)
  timesCorrect     Int               @default(0)
  averageTime      Float?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  relatedArticle   KnowledgeArticle? @relation(fields: [relatedArticleId], references: [id])

  @@index([category])
  @@index([difficulty])
  @@index([isActive])
  @@map("quiz_questions")
}

model CerebellumQuery {
  id             String             @id @default(cuid())
  userId         String?
  query          String
  response       String
  model          String             @default("gpt-4")
  tokens         Int?
  responseTime   Float?
  wasHelpful     Boolean?
  feedback       String?
  rating         Int?
  country        String?
  language       String?
  createdAt      DateTime           @default(now())
  sourceArticles KnowledgeArticle[] @relation("CerebellumQueryToKnowledgeArticle")

  @@index([userId])
  @@index([createdAt])
  @@index([wasHelpful])
  @@map("cerebellum_queries")
}

model CerebellumSubscription {
  id                   String   @id @default(cuid())
  userId               String   @unique
  tier                 String   @default("FREE")
  queriesLimit         Int      @default(10)
  queriesUsed          Int      @default(0)
  resetDate            DateTime
  hasPrioritySupport   Boolean  @default(false)
  hasAdvancedAnalytics Boolean  @default(false)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@map("cerebellum_subscriptions")
}

model EmailSubscriber {
  id                  String    @id @default(cuid())
  email               String    @unique
  name                String?
  archetype           String?
  source              String
  sourceMetadata      Json?
  status              String    @default("active")
  unsubscribedAt      DateTime?
  unsubscribeReason   String?
  openRate            Float     @default(0)
  clickRate           Float     @default(0)
  lastEmailOpenedAt   DateTime?
  lastEmailClickedAt  DateTime?
  engagementScore     String    @default("warm")
  currentJourneyStage String    @default("subscribed")
  tags                String[]  @default([])
  downloadedGuide     Boolean   @default(false)
  enrolledCourse      Boolean   @default(false)
  purchasedManual     Boolean   @default(false)
  purchasedCourse     Boolean   @default(false)
  emailsSent          Int       @default(0)
  emailsOpened        Int       @default(0)
  emailsClicked       Int       @default(0)
  lastEmailSentAt     DateTime?
  leadId              String?
  userId              String?
  hostProfileTestId   String?
  subscribedAt        DateTime  @default(now())
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  becameHotAt         DateTime?
  bouncedAt           DateTime?
  emailsBounced       Int       @default(0)
  emailsDelivered     Int       @default(0)
  firstOpenedAt       DateTime?
  lastEngagement      DateTime?
  day10SentAt         DateTime?
  day14SentAt         DateTime?
  day3SentAt          DateTime?
  day7SentAt          DateTime?
  sequenceStartedAt   DateTime?
  sequenceStatus      String    @default("active")
  contentTrack        String?
  interests           String[]  @default([])
  topPriority         String?
  convertedAt         DateTime?
  lastClickedAt       DateTime?
  lastOpenedAt        DateTime?
  nivel               String?
  nivelDay1SentAt     DateTime?
  nivelDay2SentAt     DateTime?
  nivelDay3SentAt     DateTime?
  nivelDay5SentAt     DateTime?
  nivelDay7SentAt     DateTime?
  nivelSequenceStatus String    @default("pending")
  perfilInteres       String?
  quizScore           Int?
  soapEmail1SentAt    DateTime?
  soapEmail2SentAt    DateTime?
  soapEmail3SentAt    DateTime?
  soapEmail4SentAt    DateTime?
  soapEmail5SentAt    DateTime?
  soapEmail6SentAt    DateTime?
  soapEmail7SentAt    DateTime?
  soapEmail8SentAt    DateTime?
  soapOperaStartedAt  DateTime?
  soapOperaStatus     String    @default("pending")
  totalClicks         Int       @default(0)
  totalOpens          Int       @default(0)
  trialStartedAt      DateTime?

  @@index([email])
  @@index([archetype])
  @@index([source])
  @@index([status])
  @@index([engagementScore])
  @@index([currentJourneyStage])
  @@index([subscribedAt])
  @@map("email_subscribers")
}

model HostProfileTest {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  email             String?
  name              String?
  gender            String?
  emailConsent      Boolean  @default(false)
  shareConsent      Boolean  @default(false)
  answers           Json
  scoreHospitalidad Float
  scoreComunicacion Float
  scoreOperativa    Float
  scoreCrisis       Float
  scoreData         Float
  scoreLimites      Float
  scoreMkt          Float
  scoreBalance      Float
  archetype         String
  topStrength       String
  criticalGap       String
  userId            String?
  user              User?    @relation(fields: [userId], references: [id])

  @@index([archetype])
  @@index([email])
  @@index([createdAt])
  @@map("host_profile_tests")
}

model EmailSequence {
  id                   String               @id @default(cuid())
  name                 String
  description          String?
  triggerEvent         String
  targetArchetype      String?
  targetSource         String?
  targetTags           String[]             @default([])
  isActive             Boolean              @default(true)
  priority             Int                  @default(0)
  subscribersEnrolled  Int                  @default(0)
  subscribersCompleted Int                  @default(0)
  subscribersActive    Int                  @default(0)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  steps                EmailSequenceStep[]
  enrollments          SequenceEnrollment[]

  @@index([triggerEvent])
  @@index([isActive])
  @@map("email_sequences")
}

model EmailSequenceStep {
  id                    String           @id @default(cuid())
  sequenceId            String
  name                  String
  subject               String
  templateName          String
  templateData          Json?
  delayDays             Int              @default(0)
  delayHours            Int              @default(0)
  sendAtHour            Int?
  order                 Int              @default(0)
  requiresPreviousOpen  Boolean          @default(false)
  requiresPreviousClick Boolean          @default(false)
  isActive              Boolean          @default(true)
  emailsSent            Int              @default(0)
  emailsDelivered       Int              @default(0)
  emailsOpened          Int              @default(0)
  emailsClicked         Int              @default(0)
  emailsBounced         Int              @default(0)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  sequence              EmailSequence    @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  scheduledEmails       ScheduledEmail[]

  @@index([sequenceId, order])
  @@map("email_sequence_steps")
}

model SequenceEnrollment {
  id               String           @id @default(cuid())
  subscriberId     String
  sequenceId       String
  status           String           @default("active")
  currentStepOrder Int              @default(0)
  enrolledAt       DateTime         @default(now())
  completedAt      DateTime?
  pausedAt         DateTime?
  unsubscribedAt   DateTime?
  emailsSent       Int              @default(0)
  emailsOpened     Int              @default(0)
  emailsClicked    Int              @default(0)
  metadata         Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  scheduledEmails  ScheduledEmail[]
  sequence         EmailSequence    @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, sequenceId])
  @@index([subscriberId])
  @@index([sequenceId, status])
  @@map("sequence_enrollments")
}

model ScheduledEmail {
  id             String             @id @default(cuid())
  enrollmentId   String
  stepId         String
  subscriberId   String
  recipientEmail String
  recipientName  String?
  subject        String
  templateName   String
  templateData   Json?
  scheduledFor   DateTime
  sendAttempts   Int                @default(0)
  status         String             @default("pending")
  sentAt         DateTime?
  deliveredAt    DateTime?
  failedAt       DateTime?
  errorMessage   String?
  resendId       String?            @unique
  openedAt       DateTime?
  clickedAt      DateTime?
  bouncedAt      DateTime?
  complainedAt   DateTime?
  unsubscribedAt DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  enrollment     SequenceEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  step           EmailSequenceStep  @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([status, scheduledFor])
  @@index([subscriberId])
  @@index([enrollmentId])
  @@index([resendId])
  @@map("scheduled_emails")
}

model AdminAuditLog {
  id              String   @id @default(cuid())
  adminId         String
  adminName       String
  adminEmail      String
  targetUserId    String?
  targetUserEmail String?
  targetUserName  String?
  action          String
  propertyId      String?
  propertyName    String?
  zoneId          String?
  zoneName        String?
  metadata        Json?
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())
  admin           Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, createdAt])
  @@index([targetUserId, createdAt])
  @@index([action, createdAt])
  @@index([propertyId, createdAt])
  @@map("admin_audit_logs")
}

model FaqSubmission {
  id          String              @id @default(cuid())
  question    String
  email       String?
  userId      String?
  status      FaqSubmissionStatus @default(PENDING)
  answer      String?
  category    String?
  isPublished Boolean             @default(false)
  publishedId String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  answeredAt  DateTime?
  answeredBy  String?
  user        User?               @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([createdAt])
  @@map("faq_submissions")
}

model EmailLog {
  id        String   @id @default(cuid())
  userId    String
  type      String
  email     String
  subject   String?
  resendId  String?
  status    String   @default("SENT")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, type])
  @@index([type, createdAt])
  @@map("email_logs")
}

model ConsultationBooking {
  id            String    @id @default(cuid())
  email         String
  name          String
  properties    String
  challenge     String?
  scheduledDate DateTime
  status        String    @default("scheduled")
  source        String    @default("direct")
  meetLink      String?
  notes         String?
  metadata      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  completedAt   DateTime?
  adminNotes    String?
  leadId        String?

  @@index([email])
  @@index([scheduledDate])
  @@index([status])
  @@map("consultation_bookings")
}

model BlockedSlot {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  time      String?
  reason    String?
  createdAt DateTime @default(now())

  @@unique([date, time])
  @@index([date])
  @@map("blocked_slots")
}

model PropertyOwner {
  id                   String                  @id @default(cuid())
  userId               String
  nif                  String?
  address              String
  city                 String
  postalCode           String
  country              String                  @default("Espa√±a")
  email                String
  phone                String?
  iban                 String?
  isActive             Boolean                 @default(true)
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  cif                  String?
  companyName          String?
  firstName            String?
  lastName             String?
  type                 OwnerType               @default(PERSONA_FISICA)
  retentionRate        Decimal?                @db.Decimal(5, 2) // IRPF retention %, null = use default (15% empresa, 0% persona f√≠sica)
  documentType         DocumentType            @default(INVOICE)
  magicLinkLastAccess  DateTime?
  magicLinkToken       String?                 @unique
  magicLinkTokenExpiry DateTime?
  billingUnitGroups    BillingUnitGroup[]
  billingUnits         BillingUnit[]
  clientInvoices       ClientInvoice[]
  liquidations         Liquidation[]
  billingConfigs       PropertyBillingConfig[]
  user                 User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@map("property_owners")
}

model PropertyBillingConfig {
  id                   String               @id @default(cuid())
  propertyId           String               @unique
  ownerId              String?
  incomeReceiver       IncomeReceiver       @default(OWNER)
  commissionType       CommissionType       @default(PERCENTAGE)
  commissionValue      Decimal              @default(0)
  commissionVat        Decimal              @default(21)
  cleaningType         CleaningType         @default(FIXED_PER_RESERVATION)
  cleaningValue        Decimal              @default(0)
  cleaningVatIncluded  Boolean              @default(true)
  monthlyFee           Decimal              @default(0)
  monthlyFeeVat        Decimal              @default(21)
  monthlyFeeConcept    String?
  icalUrl              String?
  lastIcalSync         DateTime?
  isActive             Boolean              @default(true)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  cleaningFeeRecipient CleaningFeeRecipient @default(MANAGER)
  cleaningFeeSplitPct  Decimal?
  defaultRetentionRate Decimal              @default(0)
  defaultVatRate       Decimal              @default(21)
  invoiceDetailLevel   InvoiceDetailLevel   @default(DETAILED)
  airbnbNames          String[]             @default([])
  bookingNames         String[]             @default([])
  vrboNames            String[]             @default([])
  singleConceptText    String?
  owner                PropertyOwner?       @relation(fields: [ownerId], references: [id])
  property             Property             @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  expenses             PropertyExpense[]
  reservations         Reservation[]

  @@index([ownerId])
  @@map("property_billing_configs")
}

model BillingUnitGroup {
  id                   String               @id @default(cuid())
  userId               String
  name                 String
  imageUrl             String?
  ownerId              String
  incomeReceiver       IncomeReceiver       @default(OWNER)
  commissionType       CommissionType       @default(PERCENTAGE)
  commissionValue      Decimal              @default(0)
  commissionVat        Decimal              @default(21)
  cleaningType         CleaningType         @default(FIXED_PER_RESERVATION)
  cleaningValue        Decimal              @default(0)
  cleaningVatIncluded  Boolean              @default(true)
  cleaningFeeRecipient CleaningFeeRecipient @default(MANAGER)
  cleaningFeeSplitPct  Decimal?
  monthlyFee           Decimal              @default(0)
  monthlyFeeVat        Decimal              @default(21)
  monthlyFeeConcept    String?
  defaultVatRate       Decimal              @default(21)
  defaultRetentionRate Decimal              @default(0)
  invoiceDetailLevel   InvoiceDetailLevel   @default(DETAILED)
  singleConceptText    String?
  isActive             Boolean              @default(true)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  owner                PropertyOwner        @relation(fields: [ownerId], references: [id])
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  billingUnits         BillingUnit[]
  invoices             ClientInvoice[]

  @@index([userId])
  @@index([ownerId])
  @@map("billing_unit_groups")
}

model BillingUnit {
  id                   String               @id @default(cuid())
  userId               String
  name                 String
  city                 String?
  imageUrl             String?
  ownerId              String?
  airbnbNames          String[]             @default([])
  bookingNames         String[]             @default([])
  vrboNames            String[]             @default([])
  incomeReceiver       IncomeReceiver       @default(OWNER)
  commissionType       CommissionType       @default(PERCENTAGE)
  commissionValue      Decimal              @default(0)
  commissionVat        Decimal              @default(21)
  cleaningType         CleaningType         @default(FIXED_PER_RESERVATION)
  cleaningValue        Decimal              @default(0)
  cleaningVatIncluded  Boolean              @default(true)
  cleaningFeeRecipient CleaningFeeRecipient @default(MANAGER)
  cleaningFeeSplitPct  Decimal?
  monthlyFee           Decimal              @default(0)
  monthlyFeeVat        Decimal              @default(21)
  monthlyFeeConcept    String?
  defaultVatRate       Decimal              @default(21)
  defaultRetentionRate Decimal              @default(0)
  invoiceDetailLevel   InvoiceDetailLevel   @default(DETAILED)
  singleConceptText    String?
  icalUrl              String?
  lastIcalSync         DateTime?
  isActive             Boolean              @default(true)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  groupId              String?
  address              String?
  postalCode           String?
  group                BillingUnitGroup?    @relation(fields: [groupId], references: [id])
  owner                PropertyOwner?       @relation(fields: [ownerId], references: [id])
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices             ClientInvoice[]
  expenses             PropertyExpense[]
  reservations         Reservation[]

  @@index([userId])
  @@index([groupId])
  @@index([ownerId])
  @@map("billing_units")
}

model Guest {
  id                   String                @id @default(cuid())
  userId               String
  email                String?
  name                 String
  phone                String?
  country              String?
  notes                String?
  totalStays           Int                   @default(0)
  totalSpent           Decimal               @default(0)
  firstStayAt          DateTime?
  lastStayAt           DateTime?
  averageStay          Float                 @default(0)
  tags                 String[]              @default([])
  preferences          Json?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  chatbotConversations ChatbotConversation[]
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  reservations         Reservation[]

  @@unique([userId, email])
  @@index([userId])
  @@index([email])
  @@index([name])
  @@map("guests")
}

model ChatbotConversation {
  id                  String    @id @default(cuid())
  propertyId          String
  guestId             String?
  zoneId              String?
  language            String    @default("es")
  sessionId           String    @unique
  messages            Json      @default("[]")
  unansweredQuestions Json      @default("[]")
  guestEmail          String?
  guestName           String?
  followUpSentAt      DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  guest               Guest?    @relation(fields: [guestId], references: [id])
  property            Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([guestEmail])
  @@index([createdAt])
  @@index([followUpSentAt])
  @@map("chatbot_conversations")
}

model Reservation {
  id                   String                 @id @default(cuid())
  userId               String
  billingConfigId      String?
  platform             ReservationPlatform
  confirmationCode     String
  guestName            String
  guestCountry         String?
  guestEmail           String?
  guestPhone           String?
  travelers            Json?
  checkIn              DateTime
  checkInTime          String?
  checkOut             DateTime
  checkOutTime         String?
  nights               Int
  roomTotal            Decimal
  cleaningFee          Decimal                @default(0)
  guestServiceFee      Decimal                @default(0)
  hostServiceFee       Decimal                @default(0)
  hostEarnings         Decimal
  currency             String                 @default("EUR")
  type                 ReservationType        @default(BOOKING)
  relatedReservationId String?
  status               ReservationStatus      @default(CONFIRMED)
  guestMessage         String?
  internalNotes        String?
  importSource         String?
  rawEmailData         String?
  liquidationId        String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  cleaningAmount       Decimal?
  invoiceItemId        String?
  invoiced             Boolean                @default(false)
  managerAmount        Decimal?
  ownerAmount          Decimal?
  guestId              String?
  unit                 String?
  importBatchId        String?
  sourceListingName    String?
  billingUnitId        String?
  payments             ReservationPayment[]
  billingConfig        PropertyBillingConfig? @relation(fields: [billingConfigId], references: [id])
  billingUnit          BillingUnit?           @relation(fields: [billingUnitId], references: [id])
  guest                Guest?                 @relation(fields: [guestId], references: [id])
  invoiceItem          ClientInvoiceItem?     @relation(fields: [invoiceItemId], references: [id])
  liquidation          Liquidation?           @relation(fields: [liquidationId], references: [id])
  relatedReservation   Reservation?           @relation("ReservationRelation", fields: [relatedReservationId], references: [id])
  relatedReservations  Reservation[]          @relation("ReservationRelation")
  user                 User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([billingConfigId, platform, confirmationCode])
  @@index([userId])
  @@index([billingConfigId])
  @@index([billingUnitId])
  @@index([guestId])
  @@index([checkIn])
  @@index([checkOut])
  @@index([status])
  @@index([liquidationId])
  @@index([invoiced])
  @@index([importBatchId])
  @@index([userId, checkIn])
  @@index([userId, status])
  @@index([userId, billingUnitId, checkIn])
  @@index([userId, billingConfigId])
  @@index([userId, status, checkOut])
  @@map("reservations")
}

model ReservationPayment {
  id            String           @id @default(cuid())
  reservationId String
  userId        String
  paymentDate   DateTime
  amount        Decimal
  currency      String           @default("EUR")
  paymentType   PaymentType
  category      PaymentCategory?
  description   String?
  source        PaymentSource    @default(EMAIL)
  emailId       String?
  rawEmailData  String?
  billingAction BillingAction    @default(NORMAL)
  invoiceId     String?
  invoiceLineId String?
  autoDetected  Boolean          @default(true)
  userReviewed  Boolean          @default(false)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  invoice       ClientInvoice?   @relation(fields: [invoiceId], references: [id])
  reservation   Reservation      @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@index([userId])
  @@index([paymentDate])
  @@index([billingAction])
  @@map("reservation_payments")
}

model PropertyExpense {
  id              String                 @id @default(cuid())
  userId          String
  billingConfigId String?
  date            DateTime
  concept         String
  category        ExpenseCategory
  amount          Decimal
  vatAmount       Decimal                @default(0)
  invoiceUrl      String?
  invoiceNumber   String?
  supplierName    String?
  supplierNif     String?
  chargeToOwner   Boolean                @default(true)
  liquidationId   String?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  billingUnitId   String?
  billingConfig   PropertyBillingConfig? @relation(fields: [billingConfigId], references: [id])
  billingUnit     BillingUnit?           @relation(fields: [billingUnitId], references: [id])
  liquidation     Liquidation?           @relation(fields: [liquidationId], references: [id])
  user            User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([billingConfigId])
  @@index([billingUnitId])
  @@index([date])
  @@index([liquidationId])
  @@index([userId, billingConfigId])
  @@index([userId, billingUnitId])
  @@map("property_expenses")
}

model Liquidation {
  id                 String            @id @default(cuid())
  userId             String
  ownerId            String
  year               Int
  month              Int
  totalIncome        Decimal
  totalCommission    Decimal
  totalCommissionVat Decimal
  totalCleaning      Decimal
  totalExpenses      Decimal
  totalAmount        Decimal
  status             LiquidationStatus @default(DRAFT)
  pdfUrl             String?
  invoiceId          String?           // Link to the generated invoice
  invoiceNumber      String?           // Cached for quick reference
  invoiceDate        DateTime?
  invoiceSeries      String?
  notes              String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  totalRetention     Decimal           @default(0)
  owner              PropertyOwner     @relation(fields: [ownerId], references: [id])
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoice            ClientInvoice?    @relation(fields: [invoiceId], references: [id])
  expenses           PropertyExpense[]
  reservations       Reservation[]

  @@unique([userId, ownerId, year, month])
  @@index([userId])
  @@index([ownerId])
  @@index([status])
  @@index([invoiceId])
  @@map("liquidations")
}

model UserInvoiceConfig {
  id                       String          @id @default(cuid())
  userId                   String          @unique
  businessName             String
  nif                      String
  address                  String
  city                     String
  postalCode               String
  country                  String          @default("Espa√±a")
  logoUrl                  String?
  footerNotes              String?
  inboundEmailToken        String          @unique @default(cuid())
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt
  email                    String?
  phone                    String?
  bankName                 String?
  bic                      String?
  bizumPhone               String?
  defaultPaymentMethod     String?
  iban                     String?
  paymentMethods           Json?
  paypalEmail              String?
  onboardingCompletedAt    DateTime?
  onboardingReminderSentAt DateTime?
  onboardingSkippedAt      DateTime?
  // VeriFactu configuration
  verifactuEnabled         Boolean         @default(false)
  siiExempt                Boolean         @default(false)
  verifactuApiKey          String?
  invoiceSeries            InvoiceSeries[]
  user                     User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_invoice_configs")
}

model InvoiceSeries {
  id              String            @id @default(cuid())
  invoiceConfigId String
  name            String
  prefix          String
  year            Int
  currentNumber   Int               @default(0)
  isDefault       Boolean           @default(false)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  lastResetYear   Int?
  resetYearly     Boolean           @default(true)
  type            SeriesType        @default(STANDARD)
  invoices        ClientInvoice[]
  invoiceConfig   UserInvoiceConfig @relation(fields: [invoiceConfigId], references: [id], onDelete: Cascade)

  @@unique([invoiceConfigId, prefix, year])
  @@map("invoice_series")
}

model ClientInvoice {
  id                 String               @id @default(cuid())
  userId             String
  seriesId           String
  number             Int?
  fullNumber         String?
  issueDate          DateTime
  dueDate            DateTime?
  subtotal           Decimal
  totalVat           Decimal
  total              Decimal
  status             ClientInvoiceStatus  @default(DRAFT)
  isRectifying       Boolean              @default(false)
  rectifiesId        String?
  rectifyingReason   String?
  pdfUrl             String?
  notes              String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  ownerId            String
  isLocked           Boolean              @default(false)
  issuedAt           DateTime?
  originalTotal      Decimal?
  paymentMethodUsed  String?
  rectifyingType     RectifyingType?
  retentionAmount    Decimal              @default(0)
  retentionRate      Decimal              @default(0)
  periodMonth        Int?
  periodYear         Int?
  propertyId         String?
  emailBody          String?
  emailSubject       String?
  publicToken        String?              @unique
  sentAt             DateTime?
  sentTo             String?
  billingUnitId      String?
  billingUnitGroupId String?
  // VeriFactu fields
  verifactuHash          String?
  verifactuPreviousHash  String?
  verifactuStatus        VerifactuStatus?
  verifactuTimestamp     DateTime?
  invoiceType            AEATInvoiceType?
  taxRegimeKey           String?              @default("01")
  qrCode                 String?
  items              ClientInvoiceItem[]
  auditLogs          InvoiceAuditLog[]
  verifactuSubmissions VerifactuSubmission[]
  billingUnitGroup   BillingUnitGroup?    @relation(fields: [billingUnitGroupId], references: [id])
  billingUnit        BillingUnit?         @relation(fields: [billingUnitId], references: [id])
  owner              PropertyOwner        @relation(fields: [ownerId], references: [id])
  property           Property?            @relation(fields: [propertyId], references: [id])
  rectifies          ClientInvoice?       @relation("InvoiceRectification", fields: [rectifiesId], references: [id])
  rectifiedBy        ClientInvoice[]      @relation("InvoiceRectification")
  series             InvoiceSeries        @relation(fields: [seriesId], references: [id])
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments           ReservationPayment[]
  liquidations       Liquidation[]

  @@unique([seriesId, number])
  @@index([userId])
  @@index([ownerId])
  @@index([propertyId])
  @@index([billingUnitId])
  @@index([billingUnitGroupId])
  @@index([status])
  @@index([issueDate])
  @@index([ownerId, issueDate])
  @@index([verifactuStatus])
  @@map("client_invoices")
}

model ClientInvoiceItem {
  id            String        @id @default(cuid())
  invoiceId     String
  concept       String
  quantity      Decimal       @default(1)
  unitPrice     Decimal
  vatRate       Decimal       @default(21)
  total         Decimal
  createdAt     DateTime      @default(now())
  order         Int           @default(0)
  retentionRate Decimal       @default(0)
  description   String?
  periodEnd     DateTime?
  periodStart   DateTime?
  reservationId String?
  invoice       ClientInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  reservations  Reservation[]

  @@index([invoiceId])
  @@index([reservationId])
  @@map("client_invoice_items")
}

model ReservationImport {
  id            String   @id @default(cuid())
  userId        String
  fileName      String
  source        String   @default("AIRBNB")
  importDate    DateTime @default(now())
  totalRows     Int
  importedCount Int      @default(0)
  skippedCount  Int      @default(0)
  errorCount    Int      @default(0)
  errors        Json?
  propertyId    String?
  createdAt     DateTime @default(now())
  importBatchId String?  @unique
  listingsFound Json?
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([importDate])
  @@index([importBatchId])
  @@map("reservation_imports")
}

model ImportTemplate {
  id                     String   @id @default(cuid())
  userId                 String
  name                   String
  guestNameColumn        Int
  checkInColumn          Int
  checkOutColumn         Int
  amountColumn           Int
  confirmationCodeColumn Int?
  nightsColumn           Int?
  cleaningFeeColumn      Int?
  commissionColumn       Int?
  statusColumn           Int?
  dateFormat             String   @default("DD/MM/YYYY")
  numberFormat           String   @default("EU")
  amountType             String   @default("NET")
  platform               String   @default("OTHER")
  originalHeaders        Json?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@map("import_templates")
}

model GmailIntegration {
  id           String             @id @default(cuid())
  userId       String             @unique
  email        String
  accessToken  String
  refreshToken String
  tokenExpiry  DateTime
  isActive     Boolean            @default(true)
  lastSyncAt   DateTime?
  syncErrors   Int                @default(0)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  syncedEmails GmailSyncedEmail[]

  @@map("gmail_integrations")
}

model GmailSyncedEmail {
  id                 String           @id @default(cuid())
  gmailIntegrationId String
  messageId          String
  threadId           String?
  subject            String?
  fromEmail          String
  receivedAt         DateTime
  emailType          String
  parsedData         Json?
  status             String           @default("PENDING")
  errorMessage       String?
  reservationId      String?
  createdAt          DateTime         @default(now())
  gmailIntegration   GmailIntegration @relation(fields: [gmailIntegrationId], references: [id], onDelete: Cascade)

  @@unique([gmailIntegrationId, messageId])
  @@index([gmailIntegrationId, status])
  @@index([receivedAt])
  @@map("gmail_synced_emails")
}

enum ModuleType {
  MANUALES
  GESTION
  FACTURAMIO
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  SPAM
  PENDING_VERIFICATION
}

enum BlogCategory {
  GUIAS
  MEJORES_PRACTICAS
  NORMATIVA
  AUTOMATIZACION
  MARKETING
  OPERACIONES
  CASOS_ESTUDIO
  NOTICIAS
}

enum BlogStatus {
  DRAFT
  REVIEW
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

enum JourneyStage {
  VISITOR
  LEAD
  REGISTERED
  MQL
  SQL
  CUSTOMER
  CHURNED
}

enum EmailEventType {
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
  UNSUBSCRIBED
}

enum EmailTrigger {
  ON_LEAD_CAPTURE
  ON_REGISTRATION
  ON_TRIAL_START
  ON_SUBSCRIPTION
  ON_INACTIVITY
  ON_CANCELLATION
  MANUAL
}

enum FaqSubmissionStatus {
  PENDING
  REVIEWING
  ANSWERED
  PUBLISHED
  REJECTED
}

enum OwnerType {
  PERSONA_FISICA
  EMPRESA
}

enum DocumentType {
  INVOICE
  SERVICE_NOTE
  NONE
}

enum IncomeReceiver {
  OWNER
  MANAGER
}

enum CommissionType {
  PERCENTAGE
  FIXED_PER_RESERVATION
  FIXED_MONTHLY
  NONE
}

enum CleaningType {
  FIXED_PER_RESERVATION
  PER_NIGHT
  NONE
}

enum CleaningFeeRecipient {
  OWNER
  MANAGER
  SPLIT
}

enum InvoiceDetailLevel {
  DETAILED
  SUMMARY
}

enum ReservationPlatform {
  AIRBNB
  BOOKING
  VRBO
  DIRECT
  OTHER
}

enum ReservationType {
  BOOKING
  CANCELLATION
  MODIFICATION
  REFUND
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum PaymentType {
  PAYOUT
  REFUND
  RESOLUTION
  ADJUSTMENT
  MANUAL
}

enum PaymentCategory {
  ACCOMMODATION
  CLEANING
  DAMAGE
  COMPENSATION
  OTHER
}

enum PaymentSource {
  EMAIL
  MANUAL
  CSV
  API
}

enum BillingAction {
  NORMAL
  PASSTHROUGH
  MANAGER_KEEPS
  EXCLUDE
}

enum ExpenseCategory {
  MAINTENANCE
  SUPPLIES
  REPAIR
  CLEANING
  FURNITURE
  TAXES
  INSURANCE
  OTHER
}

enum LiquidationStatus {
  DRAFT      // Can edit, recalculate
  SENT       // Sent to owner for review
  CANCELLED  // Cancelled
  // Note: Liquidation locks automatically when linked invoice is ISSUED
}

enum ClientInvoiceStatus {
  DRAFT
  ISSUED
  SENT
  PAID
  OVERDUE
  PROFORMA
}

enum RectifyingType {
  SUBSTITUTION
  DIFFERENCE
}

// ============================================
// Local Recommendations System
// ============================================

model Place {
  id              String           @id @default(cuid())
  placeId         String?          @unique
  osmId           String?          @unique
  source          String           // "GOOGLE" | "OSM"
  name            String
  address         String
  phone           String?
  website         String?
  photoUrl        String?
  rating          Float?
  priceLevel      Int?
  types           Json?
  openingHours    Json?            // Google weekday_text array: ["lunes: 09:00‚Äì21:00", ...]
  latitude        Float
  longitude       Float
  businessStatus  String?          // "OPERATIONAL" | "CLOSED_TEMPORARILY" | "CLOSED_PERMANENTLY"
  lastFetchedAt   DateTime
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  recommendations Recommendation[]

  @@map("places")
}

model NearbyCache {
  id            String   @id @default(cuid())
  tileKey       String
  category      String
  placeIds      Json
  lastFetchedAt DateTime

  @@unique([tileKey, category])
  @@map("nearby_cache")
}

model DirectionsCache {
  id            String   @id @default(cuid())
  originQuery   String
  destTileKey   String
  mode          String
  result        Json
  lastFetchedAt DateTime

  @@unique([originQuery, destTileKey, mode])
  @@map("directions_cache")
}

model Recommendation {
  id                      String    @id @default(cuid())
  zoneId                  String
  zone                    Zone      @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  placeId                 String?
  place                   Place?    @relation(fields: [placeId], references: [id])
  description             String?
  descriptionTranslations Json?
  source                  String    @default("AUTO_NEARBY")
  distanceMeters          Int?
  walkMinutes             Int?
  order                   Int       @default(0)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@unique([zoneId, placeId])
  @@index([zoneId, order])
  @@map("recommendations")
}

enum SeriesType {
  STANDARD
  RECTIFYING
}

// ============================================
// VeriFactu (RD 1007/2023)
// ============================================

enum VerifactuStatus {
  PENDING
  SUBMITTED
  ACCEPTED
  REJECTED
  ERROR
}

enum AEATInvoiceType {
  F1  // Factura completa
  F2  // Factura simplificada
  F3  // Factura emitida en sustituci√≥n de facturas simplificadas
  R1  // Rectificativa por art. 80.1, 80.2 y 80.6 LIVA
  R2  // Rectificativa por art. 80.3 LIVA
  R3  // Rectificativa por art. 80.4 LIVA
  R4  // Rectificativa otros
  R5  // Rectificativa en facturas simplificadas
}

model InvoiceAuditLog {
  id           String        @id @default(cuid())
  invoiceId    String
  action       String        // CREATED, ISSUED, HASH_GENERATED, QR_GENERATED, VERIFACTU_SUBMITTED, STATUS_CHANGED, etc.
  previousData Json?
  newData      Json?
  userId       String
  createdAt    DateTime      @default(now())
  invoice      ClientInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([createdAt])
  @@map("invoice_audit_logs")
}

model VerifactuSubmission {
  id          String        @id @default(cuid())
  invoiceId   String
  xmlPayload  String
  response    String?
  status      VerifactuStatus @default(PENDING)
  errorCode   String?
  errorMessage String?
  submittedAt DateTime      @default(now())
  respondedAt DateTime?
  invoice     ClientInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([status])
  @@map("verifactu_submissions")
}

enum PaymentMethodType {
  TRANSFER
  DIRECT_DEBIT
  CASH
  CARD
  BIZUM
  PAYPAL
}

// ============================================
// Public API v1 ‚Äî PMS Integrations
// ============================================

model ApiKey {
  id            String         @id @default(cuid())
  userId        String
  name          String
  hashedKey     String         @unique
  prefix        String
  permissions   Json           @default("[\"properties:read\",\"webhooks:write\",\"guidebook:write\",\"guidebook:read\"]")
  lastUsedAt    DateTime?
  createdAt     DateTime       @default(now())
  revokedAt     DateTime?
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  webhookEvents WebhookEvent[]

  @@index([userId])
  @@index([hashedKey])
  @@map("api_keys")
}

model WebhookEvent {
  id          String    @id @default(cuid())
  apiKeyId    String
  eventType   String
  payload     Json
  status      String    @default("PENDING")
  error       String?
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  apiKey      ApiKey    @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@index([status])
  @@map("webhook_events")
}

model GuidebookDelivery {
  id            String    @id @default(cuid())
  propertyId    String
  reservationId String?
  guestEmail    String
  guestName     String?
  language      String    @default("es")
  guideUrl      String
  sentAt        DateTime?
  openedAt      DateTime?
  clickedAt     DateTime?
  resendEmailId String?
  source        String    @default("API")
  createdAt     DateTime  @default(now())
  property      Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([guestEmail])
  @@index([resendEmailId])
  @@map("guidebook_deliveries")
}

model PropertyExternalMapping {
  id           String   @id @default(cuid())
  propertyId   String
  platform     String
  externalId   String
  externalName String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, platform])
  @@unique([platform, externalId])
  @@map("property_external_mappings")
}
