generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enum para tipos de módulos de la plataforma
enum ModuleType {
  MANUALES
  GESTION
}

model User {
  id                      String                 @id @default(cuid())
  email                   String                 @unique
  name                    String
  phone                   String?
  password                String?
  emailVerified           DateTime?
  phoneVerified           DateTime?
  preferredLanguage       String                 @default("es")
  timezone                String                 @default("Europe/Madrid")
  role                    String                 @default("HOST")
  status                  String                 @default("PENDING")
  subscription            String?
  trialStartedAt          DateTime?
  trialEndsAt             DateTime?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  lastLoginAt             DateTime?
  avatar                  String?
  companyName             String?
  billingAddress          String?
  billingCity             String?
  billingCountry          String?
  billingPostalCode       String?
  vatNumber               String?
  referralCode            String?                @unique
  referredBy              String?
  affiliateCommission     Decimal                @default(0)
  createdBy               String?
  isActive                Boolean                @default(true)
  isAdmin                 Boolean                @default(false)
  notes                   String?
  notificationPreferences Json?                  @default("{}")
  onboardingCompletedAt   DateTime?
  academyEnrolledAt       DateTime?
  academyPoints           Int                    @default(0)
  academyStreak           Int                    @default(0)
  lastAcademyActivityAt   DateTime?
  username                String?                @unique
  academyProgress         AcademyProgress[]
  quizAttempts            QuizAttempt[]
  referralTransactions    AffiliateTransaction[] @relation("AffiliateReferred")
  referredUsers           AffiliateTransaction[] @relation("AffiliateReferrer")
  billingInfo             BillingInfo?
  callLogs                CallLog[]
  couponUses              CouponUse[]            @relation("UserCouponUses")
  journeyStages           CustomerJourneyStage[]
  emailChangeTokens       EmailChangeToken[]
  emailEvents             EmailEvent[]
  assignedErrorReports    ErrorReport[]          @relation("ErrorReportAssignee")
  hostProfileTests        HostProfileTest[]
  invoices                Invoice[]
  mediaItems              MediaLibrary[]
  notifications           Notification[]
  organization_members    organization_members[]
  properties              Property[]
  propertySets            PropertySet[]
  propertyViews           PropertyView[]         @relation("HostPropertyViews")
  subscriptionRequests    SubscriptionRequest[]  @relation("UserSubscriptionRequests")
  trackingEvents          TrackingEvent[]        @relation("UserTrackingEvents")
  achievements            UserAchievement[]
  inspirationState        UserInspirationState?
  userNotes               UserNote[]
  subscriptions           UserSubscription[]
  creator                 User?                  @relation("UserCreatedBy", fields: [createdBy], references: [id])
  createdUsers            User[]                 @relation("UserCreatedBy")
  moderatedComments       ZoneComment[]          @relation("CommentModerator")
  zoneViews               ZoneView[]             @relation("HostZoneViews")
  faqSubmissions          FaqSubmission[]
  // Módulo de gestión de reservas y facturación
  propertyOwners          PropertyOwner[]
  managedReservations     Reservation[]
  guests                  Guest[]
  propertyExpenses        PropertyExpense[]
  liquidations            Liquidation[]
  invoiceConfig           UserInvoiceConfig?
  clientInvoices          ClientInvoice[]
  reservationImports      ReservationImport[]
  gmailIntegration        GmailIntegration?
  reservationPayments     ReservationPayment[]
  importTemplates         ImportTemplate[]
  // Módulos activos del usuario
  modules                 UserModule[]

  @@map("users")
}

// Módulos activos por usuario (MANUALES y GESTION son independientes)
model UserModule {
  id                   String     @id @default(cuid())
  userId               String
  moduleType           ModuleType
  status               String     @default("ACTIVE") // ACTIVE, CANCELED, TRIAL
  isActive             Boolean    @default(true)
  activatedAt          DateTime   @default(now())
  expiresAt            DateTime?
  canceledAt           DateTime?
  stripeSubscriptionId String?    @unique
  subscriptionPlanId   String? // Solo para MANUALES
  trialEndsAt          DateTime?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionPlan SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])

  @@unique([userId, moduleType])
  @@index([userId, status])
  @@map("user_modules")
}

model BillingInfo {
  id               String   @id @default(cuid())
  userId           String   @unique
  entityType       String
  email            String
  phone            String
  address          String
  city             String
  postalCode       String
  country          String
  companyName      String?
  companyTaxId     String?
  tradeName        String?
  taxId            String?
  businessActivity String?
  firstName        String?
  lastName         String?
  nationalId       String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("billing_info")
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
  @@map("email_verification_tokens")
}

model PropertySet {
  id                  String     @id @default(cuid())
  hostId              String
  name                String
  description         String
  street              String
  city                String
  state               String
  country             String
  postalCode          String
  type                String
  profileImage        String?
  hostContactName     String
  hostContactPhone    String
  hostContactEmail    String
  hostContactLanguage String     @default("es")
  hostContactPhoto    String?
  status              String     @default("DRAFT")
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  properties          Property[]
  host                User       @relation(fields: [hostId], references: [id], onDelete: Cascade)

  @@map("property_sets")
}

model Property {
  id                      String                 @id @default(cuid())
  hostId                  String
  organizationId          String?
  buildingId              String?
  propertySetId           String?
  name                    String
  nameTranslations        Json? // {en: "...", fr: "..."}
  description             String
  descriptionTranslations Json? // {en: "...", fr: "..."}
  street                  String
  city                    String
  state                   String
  country                 String
  postalCode              String
  type                    String
  bedrooms                Int
  bathrooms               Int
  maxGuests               Int
  squareMeters            Int?
  defaultLanguages        Json                   @default("[\"es\", \"en\"]")
  isPublished             Boolean                @default(false)
  profileImage            String?
  hostContactName         String
  hostContactPhone        String
  hostContactEmail        String
  hostContactLanguage     String                 @default("es")
  hostContactPhoto        String?
  status                  String                 @default("DRAFT")
  trialStartsAt           DateTime?
  trialEndsAt             DateTime?
  trialNotified3d         Boolean                @default(false)
  trialNotified24h        Boolean                @default(false)
  trialNotified6h         Boolean                @default(false)
  trialNotified1h         Boolean                @default(false)
  subscriptionEndsAt      DateTime?
  lastPaymentDate         DateTime?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  publishedAt             DateTime?
  slug                    String?                @unique
  propertyCode            String?                @unique
  announcements           Announcement[]
  buildings               buildings?             @relation(fields: [buildingId], references: [id])
  host                    User                   @relation(fields: [hostId], references: [id], onDelete: Cascade)
  organizations           organizations?         @relation(fields: [organizationId], references: [id])
  propertySet             PropertySet?           @relation(fields: [propertySetId], references: [id])
  analytics               PropertyAnalytics?
  propertyRatings         PropertyRating[]
  propertyViews           PropertyView[]
  reviews                 Review[]
  trackingEvents          TrackingEvent[]
  zoneViews               ZoneView[]             @relation("PropertyZoneViews")
  zones                   Zone[]
  billingConfig           PropertyBillingConfig?
  clientInvoices          ClientInvoice[]

  @@index([slug])
  @@map("properties")
}

model Zone {
  id                  String          @id @default(cuid())
  propertyId          String?
  organizationId      String?
  buildingId          String?
  name                Json
  description         Json?
  icon                String
  order               Int             @default(0)
  color               String?
  qrCode              String          @unique
  accessCode          String          @unique
  whatsappEnabled     Boolean         @default(true)
  errorReportsEnabled Boolean         @default(true)
  commentsEnabled     Boolean         @default(true)
  ratingsEnabled      Boolean         @default(true)
  status              String          @default("DRAFT")
  isPublished         Boolean         @default(false)
  viewCount           Int             @default(0)
  lastViewedAt        DateTime?
  avgRating           Float           @default(0)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  publishedAt         DateTime?
  slug                String?
  errorReports        ErrorReport[]
  reviews             Review[]
  steps               Step[]
  trackingEvents      TrackingEvent[]
  analytics           ZoneAnalytics?
  comments            ZoneComment[]
  ratings             ZoneRating[]
  zoneViews           ZoneView[]      @relation("ZoneViews")
  buildings           buildings?      @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  organizations       organizations?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  property            Property?       @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, slug])
  @@index([propertyId, status])
  @@index([qrCode])
  @@index([slug])
  @@map("zones")
}

model Step {
  id          String   @id @default(cuid())
  zoneId      String
  type        String
  title       Json
  content     Json
  order       Int      @default(0)
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  zones       Zone     @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId, order])
  @@map("steps")
}

model ZoneComment {
  id               String    @id @default(cuid())
  zoneId           String
  text             String
  rating           Int
  language         String
  guestName        String?
  guestCountry     String?
  guestLanguage    String
  status           String    @default("PENDING")
  moderatedAt      DateTime?
  moderatedBy      String?
  moderationReason String?
  helpfulVotes     Int       @default(0)
  reportedCount    Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  ipAddress        String?
  userAgent        String?
  moderator        User?     @relation("CommentModerator", fields: [moderatedBy], references: [id])
  zone             Zone      @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId, status])
  @@map("zone_comments")
}

model ErrorReport {
  id               String    @id @default(cuid())
  zoneId           String
  title            String
  description      String
  category         String
  severity         String
  affectedStep     String?
  userAgent        String?
  browserInfo      String?
  deviceType       String
  language         String
  reporterEmail    String?
  reporterLanguage String
  status           String    @default("PENDING")
  priority         String    @default("MEDIUM")
  assignedTo       String?
  hostResponse     String?
  resolutionNotes  String?
  resolvedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  assignee         User?     @relation("ErrorReportAssignee", fields: [assignedTo], references: [id])
  zone             Zone      @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
  @@map("error_reports")
}

model ZoneRating {
  id                     String   @id @default(cuid())
  zoneId                 String
  overallRating          Int
  clarity                Int
  completeness           Int
  helpfulness            Int
  upToDate               Int
  feedback               String?
  improvementSuggestions String?
  language               String
  guestAgeRange          String?
  guestCountry           String?
  guestTravelType        String?
  createdAt              DateTime @default(now())
  ipAddress              String?
  visibleToHost          Boolean  @default(true)
  visibleToGuests        Boolean  @default(false)
  zone                   Zone     @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId, createdAt])
  @@map("zone_ratings")
}

model PropertyAnalytics {
  id                 String    @id @default(cuid())
  propertyId         String    @unique
  totalViews         Int       @default(0)
  uniqueVisitors     Int       @default(0)
  avgSessionDuration Int       @default(0)
  overallRating      Float     @default(0)
  totalRatings       Int       @default(0)
  improvementScore   Int       @default(0)
  whatsappClicks     Int       @default(0)
  errorReportsCount  Int       @default(0)
  commentsCount      Int       @default(0)
  lastCalculatedAt   DateTime  @default(now())
  lastViewedAt       DateTime?
  zoneViews          Int       @default(0)
  property           Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("property_analytics")
}

model DailyStats {
  id                 String   @id @default(cuid())
  propertyId         String
  date               DateTime
  views              Int      @default(0)
  uniqueVisitors     Int      @default(0)
  avgSessionDuration Int      @default(0)
  whatsappClicks     Int      @default(0)
  errorReports       Int      @default(0)
  newComments        Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([propertyId, date])
  @@index([propertyId, date])
  @@map("daily_stats")
}

model TrackingEvent {
  id         String   @id @default(cuid())
  type       String
  propertyId String
  zoneId     String?
  stepId     String?
  userId     String?
  sessionId  String?
  metadata   Json?
  timestamp  DateTime @default(now())
  userAgent  String?
  ipAddress  String?
  duration   Int?
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user       User?    @relation("UserTrackingEvents", fields: [userId], references: [id])
  zone       Zone?    @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([propertyId, type, timestamp])
  @@index([zoneId, type, timestamp])
  @@index([sessionId, timestamp])
  @@map("tracking_events")
}

model ZoneAnalytics {
  id                String    @id @default(cuid())
  zoneId            String    @unique
  totalViews        Int       @default(0)
  uniqueVisitors    Int       @default(0)
  avgTimeSpent      Int       @default(0)
  completionRate    Float     @default(0)
  avgStepsCompleted Float     @default(0)
  totalCompletions  Int       @default(0)
  avgRating         Float     @default(0)
  totalRatings      Int       @default(0)
  timeSavedMinutes  Int       @default(0)
  lastCalculatedAt  DateTime  @default(now())
  lastViewedAt      DateTime?
  totalTimeSpent    Int       @default(0)
  zone              Zone      @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@map("zone_analytics")
}

model buildings {
  id             String        @id
  organizationId String
  name           String
  street         String
  city           String
  state          String
  country        String
  postalCode     String
  latitude       Float?
  longitude      Float?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  organizations  organizations @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  properties     Property[]
  zones          Zone[]
}

model organization_members {
  id             String        @id
  organizationId String
  userId         String
  role           String
  permissions    Json          @default("[]")
  joinedAt       DateTime      @default(now())
  organizations  organizations @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
}

model organizations {
  id                   String                 @id
  name                 String
  type                 String
  description          String?
  website              String?
  logo                 String?
  brandColorPrimary    String?
  brandColorSecondary  String?
  customDomain         String?                @unique
  defaultLanguages     Json                   @default("[\"es\", \"en\"]")
  timezone             String                 @default("Europe/Madrid")
  status               String                 @default("ACTIVE")
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  buildings            buildings[]
  organization_members organization_members[]
  properties           Property[]
  zones                Zone[]
}

model UserInspirationState {
  id                   String   @id @default(cuid())
  userId               String   @unique
  dismissedZones       Json     @default("[]")
  createdZones         Json     @default("[]")
  lastShownInspiration String?
  showInspirations     Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_inspiration_states")
}

model SubscriptionPlan {
  id                 String                @id @default(cuid())
  code               String                @unique
  name               String
  description        String?
  priceMonthly       Decimal               @map("price_monthly")
  priceSemestral     Decimal?              @map("price_semestral")
  priceYearly        Decimal?              @map("price_yearly")
  aiMessagesIncluded Int                   @default(0) @map("ai_messages_included")
  maxProperties      Int                   @default(1) @map("max_properties")
  features           Json                  @default("[]")
  isActive           Boolean               @default(true) @map("is_active")
  isVisibleInUI      Boolean               @default(true) @map("is_visible_in_ui")
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  requests           SubscriptionRequest[] @relation("PlanRequests")
  subscriptions      UserSubscription[]
  userModules        UserModule[]

  @@map("subscription_plans")
}

model UserSubscription {
  id                   String            @id @default(cuid())
  userId               String            @map("user_id")
  planId               String?           @map("plan_id")
  customPlanId         String?           @map("custom_plan_id")
  status               String
  customPrice          Decimal?          @map("custom_price")
  discountPercentage   Decimal?          @default(0) @map("discount_percentage")
  discountReason       String?           @map("discount_reason")
  startDate            DateTime          @map("start_date")
  endDate              DateTime?         @map("end_date")
  notes                String?
  createdBy            String?           @map("created_by")
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")
  cancelAtPeriodEnd    Boolean           @default(false) @map("cancel_at_period_end")
  cancelReason         String?           @map("cancel_reason")
  canceledAt           DateTime?         @map("canceled_at")
  stripeSubscriptionId String?           @unique @map("stripe_subscription_id")
  invoices             Invoice[]
  customPlan           CustomPlan?       @relation(fields: [customPlanId], references: [id])
  plan                 SubscriptionPlan? @relation(fields: [planId], references: [id])
  user                 User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_subscriptions")
}

model Invoice {
  id               String            @id @default(cuid())
  userId           String            @map("user_id")
  subscriptionId   String?           @map("subscription_id")
  invoiceNumber    String            @unique @map("invoice_number")
  amount           Decimal
  discountAmount   Decimal           @default(0) @map("discount_amount")
  finalAmount      Decimal           @map("final_amount")
  status           String
  paymentMethod    String?           @map("payment_method")
  paymentReference String?           @map("payment_reference")
  dueDate          DateTime          @map("due_date")
  paidDate         DateTime?         @map("paid_date")
  notes            String?
  createdBy        String?           @map("created_by")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  subscription     UserSubscription? @relation(fields: [subscriptionId], references: [id])
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

model AdminActivityLog {
  id          String   @id @default(cuid())
  adminId     String   @map("admin_id")
  action      String
  targetType  String?  @map("target_type")
  targetId    String?  @map("target_id")
  description String?
  metadata    Json?    @default("{}")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")
  admin       Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, createdAt])
  @@map("admin_activity_log")
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String   @default("string")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model MediaLibrary {
  id           String    @id @default(cuid())
  userId       String
  type         String
  url          String
  thumbnailUrl String?
  filename     String
  originalName String
  mimeType     String
  size         Int
  duration     Int?
  width        Int?
  height       Int?
  hash         String
  tags         String[]  @default([])
  usageCount   Int       @default(0)
  isPublic     Boolean   @default(false)
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastUsedAt   DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, hash])
  @@index([userId, type])
  @@index([hash])
  @@map("media_library")
}

model PropertyRating {
  id         String    @id @default(cuid())
  propertyId String
  rating     Int
  comment    String?
  guestId    String
  guestIp    String?
  status     String    @default("PENDING")
  createdAt  DateTime  @default(now())
  reviewedAt DateTime?
  property   Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, status])
  @@index([guestId])
  @@map("property_ratings")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  data      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

model Review {
  id              String    @id @default(cuid())
  propertyId      String
  zoneId          String?
  rating          Int
  comment         String?
  userName        String    @default("Usuario anónimo")
  userEmail       String?
  reviewType      String
  isPublic        Boolean   @default(false)
  isApproved      Boolean   @default(false)
  hostResponse    String?
  hostRespondedAt DateTime?
  emailSent       Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  zone            Zone?     @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([propertyId, isPublic])
  @@index([zoneId, isPublic])
  @@index([createdAt])
  @@index([isApproved, isPublic])
  @@map("reviews")
}

model Announcement {
  id         String    @id @default(cuid())
  propertyId String
  title      Json // Multi-language support: { es: "", en: "", fr: "" }
  message    Json // Multi-language support: { es: "", en: "", fr: "" }
  category   String
  priority   String    @default("NORMAL")
  isActive   Boolean   @default(true)
  startDate  DateTime?
  endDate    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  property   Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, isActive])
  @@index([startDate, endDate])
  @@map("announcements")
}

model PropertyView {
  id           String   @id @default(cuid())
  propertyId   String
  hostId       String
  visitorIp    String
  userAgent    String?
  referrer     String?
  language     String   @default("es")
  timezone     String   @default("UTC")
  screenWidth  Int?
  screenHeight Int?
  viewedAt     DateTime @default(now())
  host         User     @relation("HostPropertyViews", fields: [hostId], references: [id], onDelete: Cascade)
  property     Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, viewedAt])
  @@index([hostId, viewedAt])
  @@index([visitorIp])
  @@map("property_views")
}

model ZoneView {
  id           String   @id @default(cuid())
  zoneId       String
  propertyId   String
  hostId       String
  visitorIp    String
  userAgent    String?
  referrer     String?
  language     String   @default("es")
  timezone     String   @default("UTC")
  screenWidth  Int?
  screenHeight Int?
  timeSpent    Int      @default(0)
  isHostView   Boolean  @default(false)
  viewedAt     DateTime @default(now())
  host         User     @relation("HostZoneViews", fields: [hostId], references: [id], onDelete: Cascade)
  property     Property @relation("PropertyZoneViews", fields: [propertyId], references: [id], onDelete: Cascade)
  zone         Zone     @relation("ZoneViews", fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([zoneId, viewedAt])
  @@index([propertyId, viewedAt])
  @@index([hostId, viewedAt])
  @@index([visitorIp])
  @@index([isHostView])
  @@map("zone_views")
}

model Admin {
  id           String             @id @default(cuid())
  email        String             @unique
  name         String
  password     String
  role         String             @default("ADMIN")
  permissions  Json               @default("[]")
  isActive     Boolean            @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  activityLogs AdminActivityLog[]
  auditLogs    AdminAuditLog[]
  callLogs     CallLog[]
  userNotes    UserNote[]

  @@map("admins")
}

model CallLog {
  id               String    @id @default(cuid())
  userId           String
  adminId          String
  type             String
  duration         Int?
  reason           String
  resolution       String?
  notes            String?
  followUpRequired Boolean   @default(false)
  followUpDate     DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  admin            Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([adminId])
  @@index([createdAt])
  @@map("call_logs")
}

model UserNote {
  id        String   @id @default(cuid())
  userId    String
  adminId   String
  type      String   @default("GENERAL")
  priority  String   @default("MEDIUM")
  title     String
  content   String
  isPrivate Boolean  @default(false)
  tags      String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([adminId])
  @@index([createdAt])
  @@map("user_notes")
}

model AffiliateTransaction {
  id             String    @id @default(cuid())
  referrerId     String    @map("referrer_id")
  referredUserId String    @map("referred_user_id")
  type           String
  amount         Decimal
  status         String    @default("PENDING")
  description    String?
  paidAt         DateTime? @map("paid_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  referredUser   User      @relation("AffiliateReferred", fields: [referredUserId], references: [id])
  referrer       User      @relation("AffiliateReferrer", fields: [referrerId], references: [id])

  @@index([referrerId])
  @@index([referredUserId])
  @@map("affiliate_transactions")
}

model Coupon {
  id                String      @id @default(cuid())
  code              String      @unique
  name              String
  description       String?
  type              String
  discountPercent   Int?
  discountAmount    Decimal?
  freeMonths        Int?
  maxUses           Int?
  usedCount         Int         @default(0)
  maxUsesPerUser    Int         @default(1)
  validFrom         DateTime    @default(now())
  validUntil        DateTime?
  minAmount         Decimal?
  minDuration       Int?
  applicableToPlans String[]
  applicableModule  ModuleType? // null = todos, MANUALES o GESTION
  isActive          Boolean     @default(true)
  isPublic          Boolean     @default(false)
  campaignSource    String?
  createdBy         String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  uses              CouponUse[]

  @@index([code])
  @@index([validFrom, validUntil])
  @@index([campaignSource])
  @@index([applicableModule])
  @@map("coupons")
}

model CouponUse {
  id              String   @id @default(cuid())
  couponId        String   @map("coupon_id")
  userId          String   @map("user_id")
  orderId         String?  @map("order_id")
  discountApplied Decimal
  originalAmount  Decimal
  finalAmount     Decimal
  createdAt       DateTime @default(now())
  coupon          Coupon   @relation(fields: [couponId], references: [id])
  user            User     @relation("UserCouponUses", fields: [userId], references: [id])

  @@index([couponId])
  @@index([userId])
  @@map("coupon_uses")
}

model CustomPlan {
  id                  String                @id @default(cuid())
  name                String
  description         String?
  pricePerProperty    Decimal
  minProperties       Int                   @default(1)
  maxProperties       Int?
  features            Json                  @default("[]")
  restrictions        Json                  @default("{}")
  isForHotels         Boolean               @default(false)
  maxZonesPerProperty Int?
  isActive            Boolean               @default(true)
  requiresApproval    Boolean               @default(false)
  createdBy           String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  requests            SubscriptionRequest[] @relation("CustomPlanRequests")
  subscriptions       UserSubscription[]

  @@map("custom_plans")
}

model EmailChangeToken {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  oldEmail    String    @map("old_email")
  newEmail    String    @map("new_email")
  token       String    @unique
  expiresAt   DateTime  @map("expires_at")
  confirmedAt DateTime? @map("confirmed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, newEmail])
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("email_change_tokens")
}

model PricingTier {
  id               String   @id @default(cuid())
  minProperties    Int      @map("min_properties")
  maxProperties    Int?     @map("max_properties")
  pricePerProperty Decimal  @map("price_per_property")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([minProperties])
  @@index([maxProperties])
  @@map("pricing_tiers")
}

model SubscriptionRequest {
  id               String            @id @default(cuid())
  userId           String            @map("user_id")
  planId           String?           @map("plan_id")
  customPlanId     String?           @map("custom_plan_id")
  requestType      String
  propertiesCount  Int?              @map("properties_count")
  totalAmount      Decimal           @map("total_amount")
  status           String            @default("PENDING")
  paymentMethod    String?           @map("payment_method")
  paymentReference String?           @map("payment_reference")
  paymentProofUrl  String?           @map("payment_proof_url")
  requestedAt      DateTime          @default(now()) @map("requested_at")
  paidAt           DateTime?         @map("paid_at")
  approvedAt       DateTime?         @map("approved_at")
  rejectedAt       DateTime?         @map("rejected_at")
  reviewedBy       String?           @map("reviewed_by")
  adminNotes       String?           @map("admin_notes")
  metadata         Json?
  customPlan       CustomPlan?       @relation("CustomPlanRequests", fields: [customPlanId], references: [id])
  plan             SubscriptionPlan? @relation("PlanRequests", fields: [planId], references: [id])
  user             User              @relation("UserSubscriptionRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
  @@map("subscription_requests")
}

model BlogPost {
  id              String        @id @default(cuid())
  slug            String        @unique
  title           String
  subtitle        String?
  excerpt         String
  content         String
  coverImage      String?
  coverImageAlt   String?
  category        BlogCategory
  tags            String[]
  featured        Boolean       @default(false)
  metaTitle       String?
  metaDescription String?
  keywords        String[]
  status          BlogStatus    @default(DRAFT)
  publishedAt     DateTime?
  scheduledFor    DateTime?
  authorId        String
  authorName      String
  views           Int           @default(0)
  uniqueViews     Int           @default(0)
  readTime        Int           @default(5)
  likes           Int           @default(0)
  shares          Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  authorImage     String?
  comments        BlogComment[]

  @@index([slug])
  @@index([status])
  @@index([category])
  @@index([publishedAt])
  @@index([featured])
  @@index([status, category, publishedAt]) // Composite index for filtered blog queries
  @@index([status, publishedAt]) // For listing all published posts by date
  @@map("blog_posts")
}

model BlogComment {
  id                 String        @id @default(cuid())
  postId             String
  post               BlogPost      @relation(fields: [postId], references: [id], onDelete: Cascade)
  parentId           String?
  parent             BlogComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies            BlogComment[] @relation("CommentReplies")
  authorName         String
  authorEmail        String
  content            String
  status             CommentStatus @default(PENDING_VERIFICATION)
  likes              Int           @default(0)
  isAuthor           Boolean       @default(false)
  emailVerified      Boolean       @default(false)
  verificationToken  String?       @unique
  verificationSentAt DateTime?
  verifiedAt         DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([postId])
  @@index([parentId])
  @@index([status])
  @@index([createdAt])
  @@index([verificationToken])
  @@map("blog_comments")
}

enum CommentStatus {
  PENDING_VERIFICATION
  PENDING
  APPROVED
  REJECTED
  SPAM
}

model Lead {
  id               String                 @id @default(cuid())
  name             String
  email            String
  source           String
  userAgent        String?
  ipAddress        String?
  metadata         Json?
  createdAt        DateTime               @default(now())
  journeyStages    CustomerJourneyStage[]
  emailEvents      EmailEvent[]
  // Funnel tracking
  funnelTheme      String?                @map("funnel_theme")
  funnelStartedAt  DateTime?              @map("funnel_started_at")
  funnelCurrentDay Int?                   @default(0) @map("funnel_current_day")
  // Property count: "1-5", "6-10", "10+", "20+"
  propertyCount    String?                @map("property_count")

  @@index([email])
  @@index([source])
  @@index([createdAt])
  @@index([funnelTheme])
  @@map("leads")
}

model CustomerJourneyStage {
  id        String       @id @default(cuid())
  leadId    String?      @map("lead_id")
  userId    String?      @map("user_id")
  email     String
  stage     JourneyStage
  score     Int          @default(0)
  enteredAt DateTime     @default(now()) @map("entered_at")
  exitedAt  DateTime?    @map("exited_at")
  metadata  Json?
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  lead      Lead?        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, stage])
  @@index([leadId])
  @@index([userId])
  @@index([stage, enteredAt])
  @@map("customer_journey_stages")
}

model EmailEvent {
  id           String         @id @default(cuid())
  leadId       String?        @map("lead_id")
  userId       String?        @map("user_id")
  email        String
  eventType    EmailEventType
  campaignId   String?        @map("campaign_id")
  templateName String         @map("template_name")
  subject      String
  sentAt       DateTime       @default(now()) @map("sent_at")
  deliveredAt  DateTime?      @map("delivered_at")
  openedAt     DateTime?      @map("opened_at")
  clickedAt    DateTime?      @map("clicked_at")
  bouncedAt    DateTime?      @map("bounced_at")
  clickedUrl   String?        @map("clicked_url")
  bounceReason String?        @map("bounce_reason")
  metadata     Json?
  campaign     EmailCampaign? @relation(fields: [campaignId], references: [id])
  lead         Lead?          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user         User?          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, eventType])
  @@index([leadId])
  @@index([userId])
  @@index([campaignId])
  @@index([sentAt])
  @@map("email_events")
}

model EmailCampaign {
  id            String         @id @default(cuid())
  name          String
  description   String?
  trigger       EmailTrigger
  triggerStages JourneyStage[]
  templateName  String         @map("template_name")
  subject       String
  fromName      String         @default("Itineramio") @map("from_name")
  fromEmail     String         @default("hola@itineramio.com") @map("from_email")
  delayMinutes  Int            @default(0) @map("delay_minutes")
  isActive      Boolean        @default(true) @map("is_active")
  sentCount     Int            @default(0) @map("sent_count")
  openedCount   Int            @default(0) @map("opened_count")
  clickedCount  Int            @default(0) @map("clicked_count")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  emailEvents   EmailEvent[]

  @@map("email_campaigns")
}

model Course {
  id              String               @id @default(cuid())
  title           String
  slug            String               @unique
  description     String
  coverImage      String?
  difficulty      String               @default("INTERMEDIATE")
  duration        Int
  passingScore    Int                  @default(80)
  published       Boolean              @default(false)
  enrollmentCount Int                  @default(0)
  isPaid          Boolean              @default(false)
  price           Decimal              @default(0)
  paymentMethods  String[]             @default([])
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  modules         Module[]
  payments        AcademyPayment[]
  reviews         AcademyReview[]
  diplomas        AcademyUserDiploma[]

  @@map("academy_courses")
}

model Module {
  id            String    @id @default(cuid())
  courseId      String
  title         String
  slug          String
  description   String
  icon          String?
  order         Int
  unlockDate    DateTime?
  estimatedTime Int
  published     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lessons       Lesson[]
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  quiz          Quiz?

  @@unique([courseId, slug])
  @@map("academy_modules")
}

model Lesson {
  id              String                @id @default(cuid())
  moduleId        String
  title           String
  slug            String
  description     String?
  slides          Json
  coverImage      String?
  videoUrl        String?
  duration        Int
  order           Int
  points          Int                   @default(10)
  published       Boolean               @default(false)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  module          Module                @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress        AcademyProgress[]
  academyProgress AcademyUserProgress[]

  @@unique([moduleId, slug])
  @@map("academy_lessons")
}

model Quiz {
  id              String                   @id @default(cuid())
  moduleId        String                   @unique
  title           String
  description     String?
  passingScore    Int                      @default(80)
  timeLimit       Int?
  maxAttempts     Int?
  points          Int                      @default(50)
  published       Boolean                  @default(false)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  questions       Question[]
  attempts        QuizAttempt[]
  module          Module                   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  academyAttempts AcademyUserQuizAttempt[]

  @@map("academy_quizzes")
}

model Question {
  id             String                  @id @default(cuid())
  quizId         String
  question       String
  type           String                  @default("MULTIPLE_CHOICE")
  options        Json
  correctAnswer  Int
  explanation    String?
  order          Int
  points         Int                     @default(1)
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  quiz           Quiz                    @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers        QuizAnswer[]
  academyAnswers AcademyUserQuizAnswer[]

  @@map("academy_questions")
}

model QuizAttempt {
  id          String       @id @default(cuid())
  userId      String
  quizId      String
  score       Float
  passed      Boolean
  startedAt   DateTime     @default(now())
  completedAt DateTime?
  timeSpent   Int?
  answers     QuizAnswer[]
  quiz        Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("academy_quiz_attempts")
}

model QuizAnswer {
  id             String      @id @default(cuid())
  attemptId      String
  questionId     String
  selectedAnswer Int
  isCorrect      Boolean
  answeredAt     DateTime    @default(now())
  attempt        QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question       Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@map("academy_quiz_answers")
}

model QuizLead {
  id                       String    @id @default(cuid())
  email                    String
  fullName                 String?
  score                    Int
  level                    String
  answers                  Json
  completedAt              DateTime  @default(now())
  timeElapsed              Int
  converted                Boolean   @default(false)
  academyUserId            String?
  source                   String    @default("QUIZ_PUBLIC")
  userAgent                String?
  ipAddress                String?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt
  emailVerified            Boolean   @default(false)
  verificationToken        String?   @unique
  verificationTokenExpires DateTime?
  verifiedAt               DateTime?

  @@index([email])
  @@index([completedAt])
  @@index([converted])
  @@index([emailVerified])
  @@index([verificationToken])
  @@map("quiz_leads")
}

model AcademyProgress {
  id             String    @id @default(cuid())
  userId         String
  lessonId       String
  completed      Boolean   @default(false)
  completedAt    DateTime?
  timeSpent      Int       @default(0)
  lastAccessedAt DateTime  @default(now())
  createdAt      DateTime  @default(now())
  lesson         Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("academy_progress")
}

model Achievement {
  id           String                   @id @default(cuid())
  code         String                   @unique
  title        String
  description  String
  icon         String?
  badge        String?
  points       Int                      @default(0)
  rarity       String                   @default("COMMON")
  createdAt    DateTime                 @default(now())
  academyUsers AcademyUserAchievement[]
  users        UserAchievement[]

  @@map("academy_achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model Diploma {
  id               String   @id @default(cuid())
  userId           String
  courseId         String
  fullName         String
  certificateCode  String   @unique
  finalScore       Float
  rank             Int?
  totalStudents    Int?
  completedAt      DateTime @default(now())
  pdfUrl           String?
  sharedToFacebook Boolean  @default(false)
  viewCount        Int      @default(0)
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([courseId])
  @@index([finalScore])
  @@index([completedAt])
  @@map("academy_diplomas")
}

model AcademyUser {
  id                       String                   @id @default(cuid())
  email                    String                   @unique
  password                 String
  fullName                 String
  username                 String?                  @unique
  avatar                   String?
  bio                      String?
  academyPoints            Int                      @default(0)
  academyStreak            Int                      @default(0)
  lastActivityAt           DateTime                 @default(now())
  enrolledAt               DateTime                 @default(now())
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt
  emailVerificationExpires DateTime?
  emailVerificationToken   String?                  @unique
  emailVerified            Boolean                  @default(false)
  day10EmailSent           Boolean                  @default(false)
  day2EmailSent            Boolean                  @default(false)
  day5EmailSent            Boolean                  @default(false)
  emailClicks              Int                      @default(0)
  emailOpens               Int                      @default(0)
  journeyStage             String                   @default("QUIZ_COMPLETED")
  lastEmailClickedAt       DateTime?
  lastEmailOpenedAt        DateTime?
  quizAnswers              Json?
  quizCompletedAt          DateTime?
  quizLevel                String?
  quizScore                Int?
  tags                     String[]                 @default([])
  welcomeEmailSent         Boolean                  @default(false)
  emailLogs                AcademyEmailLog[]
  payments                 AcademyPayment[]
  reviews                  AcademyReview[]
  achievements             AcademyUserAchievement[]
  diplomas                 AcademyUserDiploma[]
  events                   AcademyUserEvent[]
  progress                 AcademyUserProgress[]
  quizAttempts             AcademyUserQuizAttempt[]

  @@map("academy_users")
}

model AcademyUserProgress {
  id             String      @id @default(cuid())
  userId         String
  lessonId       String
  completed      Boolean     @default(false)
  completedAt    DateTime?
  timeSpent      Int         @default(0)
  lastAccessedAt DateTime    @default(now())
  createdAt      DateTime    @default(now())
  lesson         Lesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user           AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("academy_user_progress")
}

model AcademyUserQuizAttempt {
  id          String                  @id @default(cuid())
  userId      String
  quizId      String
  score       Float
  passed      Boolean
  startedAt   DateTime                @default(now())
  completedAt DateTime?
  timeSpent   Int?
  answers     AcademyUserQuizAnswer[]
  quiz        Quiz                    @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        AcademyUser             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("academy_user_quiz_attempts")
}

model AcademyUserQuizAnswer {
  id             String                 @id @default(cuid())
  attemptId      String
  questionId     String
  selectedAnswer Int
  isCorrect      Boolean
  answeredAt     DateTime               @default(now())
  attempt        AcademyUserQuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question       Question               @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@map("academy_user_quiz_answers")
}

model AcademyUserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("academy_user_achievements")
}

model AcademyUserDiploma {
  id               String      @id @default(cuid())
  userId           String
  courseId         String
  fullName         String
  certificateCode  String      @unique
  finalScore       Float
  rank             Int?
  totalStudents    Int?
  completedAt      DateTime    @default(now())
  pdfUrl           String?
  sharedToFacebook Boolean     @default(false)
  viewCount        Int         @default(0)
  createdAt        DateTime    @default(now())
  course           Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user             AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
  @@index([finalScore])
  @@map("academy_user_diplomas")
}

model AcademyReview {
  id          String      @id @default(cuid())
  userId      String
  courseId    String
  rating      Int
  testimonial String?
  isPublic    Boolean     @default(false)
  isApproved  Boolean     @default(false)
  createdAt   DateTime    @default(now())
  course      Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([courseId, isApproved, isPublic])
  @@map("academy_reviews")
}

model AcademyPayment {
  id              String      @id @default(cuid())
  userId          String
  courseId        String
  amount          Decimal
  method          String
  status          String      @default("pending")
  stripeSessionId String?     @unique
  stripePaymentId String?
  reference       String?
  proofUrl        String?
  paidAt          DateTime?
  createdAt       DateTime    @default(now())
  course          Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user            AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("academy_payments")
}

model AcademyEmailLog {
  id         String      @id @default(cuid())
  userId     String
  emailType  String
  subject    String
  sentAt     DateTime    @default(now())
  opened     Boolean     @default(false)
  openedAt   DateTime?
  clicked    Boolean     @default(false)
  clickedAt  DateTime?
  bounced    Boolean     @default(false)
  complained Boolean     @default(false)
  resendId   String?     @unique
  user       AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([emailType])
  @@index([sentAt])
  @@map("academy_email_logs")
}

model AcademyUserEvent {
  id        String      @id @default(cuid())
  userId    String
  eventType String
  eventData Json?
  createdAt DateTime    @default(now())
  user      AcademyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([eventType])
  @@map("academy_user_events")
}

model KnowledgeCategory {
  id            String              @id @default(cuid())
  name          String              @unique
  slug          String              @unique
  description   String?
  icon          String?
  color         String?
  order         Int                 @default(0)
  parentId      String?
  country       String?
  language      String              @default("es")
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  articles      KnowledgeArticle[]
  parent        KnowledgeCategory?  @relation("SubCategories", fields: [parentId], references: [id])
  subcategories KnowledgeCategory[] @relation("SubCategories")

  @@index([slug])
  @@index([country])
  @@index([order])
  @@map("knowledge_categories")
}

model KnowledgeTag {
  id       String             @id @default(cuid())
  name     String             @unique
  slug     String             @unique
  color    String?
  articles KnowledgeArticle[] @relation("ArticleTags")

  @@index([slug])
  @@map("knowledge_tags")
}

model KnowledgeArticle {
  id                   String            @id @default(cuid())
  slug                 String            @unique
  title                String
  content              String
  excerpt              String?
  metaTitle            String?
  metaDescription      String?
  keywords             String[]          @default([])
  views                Int               @default(0)
  publishedAt          DateTime?
  version              Int               @default(1)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  author               String?
  categoryId           String
  country              String?
  downvotes            Int               @default(0)
  embedding            Json?
  embeddingModel       String?
  language             String            @default("es")
  lastReviewedAt       DateTime?
  previousVersionId    String?
  sourceType           String            @default("MANUAL")
  sourceUrl            String?
  upvotes              Int               @default(0)
  status               String            @default("DRAFT")
  category             KnowledgeCategory @relation(fields: [categoryId], references: [id])
  sources              KnowledgeSource[]
  relatedQuizQuestions QuizQuestion[]
  tags                 KnowledgeTag[]    @relation("ArticleTags")
  chatbotQueries       CerebellumQuery[] @relation("CerebellumQueryToKnowledgeArticle")

  @@index([slug])
  @@index([status])
  @@index([categoryId])
  @@index([country])
  @@index([publishedAt])
  @@map("knowledge_articles")
}

model KnowledgeSource {
  id            String            @id @default(cuid())
  articleId     String?
  url           String?
  title         String
  type          String
  description   String?
  rawContent    String?
  extractedAt   DateTime?
  author        String?
  publishedDate DateTime?
  language      String            @default("es")
  country       String?
  status        String            @default("PENDING")
  errorMessage  String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  article       KnowledgeArticle? @relation(fields: [articleId], references: [id])

  @@index([url])
  @@index([status])
  @@index([type])
  @@map("knowledge_sources")
}

model QuizQuestion {
  id               String            @id @default(cuid())
  question         String
  category         String
  difficulty       String
  points           Int               @default(1)
  type             String
  options          Json
  explanation      String?
  relatedArticleId String?
  isActive         Boolean           @default(true)
  order            Int               @default(0)
  timesAsked       Int               @default(0)
  timesCorrect     Int               @default(0)
  averageTime      Float?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  relatedArticle   KnowledgeArticle? @relation(fields: [relatedArticleId], references: [id])

  @@index([category])
  @@index([difficulty])
  @@index([isActive])
  @@map("quiz_questions")
}

model CerebellumQuery {
  id             String             @id @default(cuid())
  userId         String?
  query          String
  response       String
  model          String             @default("gpt-4")
  tokens         Int?
  responseTime   Float?
  wasHelpful     Boolean?
  feedback       String?
  rating         Int?
  country        String?
  language       String?
  createdAt      DateTime           @default(now())
  sourceArticles KnowledgeArticle[] @relation("CerebellumQueryToKnowledgeArticle")

  @@index([userId])
  @@index([createdAt])
  @@index([wasHelpful])
  @@map("cerebellum_queries")
}

model CerebellumSubscription {
  id                   String   @id @default(cuid())
  userId               String   @unique
  tier                 String   @default("FREE")
  queriesLimit         Int      @default(10)
  queriesUsed          Int      @default(0)
  resetDate            DateTime
  hasPrioritySupport   Boolean  @default(false)
  hasAdvancedAnalytics Boolean  @default(false)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@map("cerebellum_subscriptions")
}

model EmailSubscriber {
  id                  String    @id @default(cuid())
  email               String    @unique
  name                String?
  archetype           String?
  source              String
  sourceMetadata      Json?
  status              String    @default("active")
  unsubscribedAt      DateTime?
  unsubscribeReason   String?
  openRate            Float     @default(0)
  clickRate           Float     @default(0)
  lastEmailOpenedAt   DateTime?
  lastEmailClickedAt  DateTime?
  engagementScore     String    @default("warm")
  currentJourneyStage String    @default("subscribed")
  tags                String[]  @default([])
  downloadedGuide     Boolean   @default(false)
  enrolledCourse      Boolean   @default(false)
  purchasedManual     Boolean   @default(false)
  purchasedCourse     Boolean   @default(false)
  emailsSent          Int       @default(0)
  emailsOpened        Int       @default(0)
  emailsClicked       Int       @default(0)
  lastEmailSentAt     DateTime?
  leadId              String?
  userId              String?
  hostProfileTestId   String?
  subscribedAt        DateTime  @default(now())
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  becameHotAt         DateTime?
  bouncedAt           DateTime?
  emailsBounced       Int       @default(0)
  emailsDelivered     Int       @default(0)
  firstOpenedAt       DateTime?
  lastEngagement      DateTime?
  day10SentAt         DateTime?
  day14SentAt         DateTime?
  day3SentAt          DateTime?
  day7SentAt          DateTime?
  sequenceStartedAt   DateTime?
  sequenceStatus      String    @default("active")
  contentTrack        String?
  interests           String[]  @default([])
  topPriority         String?
  // Nivel-based sequence tracking (from academia quiz)
  nivelDay1SentAt     DateTime?
  nivelDay2SentAt     DateTime?
  nivelDay3SentAt     DateTime?
  nivelDay5SentAt     DateTime?
  nivelDay7SentAt     DateTime?
  nivelSequenceStatus String    @default("pending")

  // ========================================
  // SOAP OPERA SEQUENCE (15 dias, 8 emails)
  // Secuencia principal de conversion
  // ========================================
  soapOperaStatus    String    @default("pending") // pending, active, completed, paused
  soapOperaStartedAt DateTime?

  // Segmentacion
  nivel         String? // principiante, intermedio, avanzado, profesional
  perfilInteres String? // automatizador, experienciador, optimizador, liberador
  quizScore     Int?

  // Emails de la secuencia (dias alternos: 1, 3, 5, 7, 9, 11, 13, 15)
  soapEmail1SentAt DateTime? // Dia 1: Bienvenida + Historia
  soapEmail2SentAt DateTime? // Dia 3: El Problema
  soapEmail3SentAt DateTime? // Dia 5: La Revelacion
  soapEmail4SentAt DateTime? // Dia 7: Caso de Exito
  soapEmail5SentAt DateTime? // Dia 9: El Metodo
  soapEmail6SentAt DateTime? // Dia 11: Objeciones
  soapEmail7SentAt DateTime? // Dia 13: Urgencia
  soapEmail8SentAt DateTime? // Dia 15: Ultima Oportunidad

  // Tracking de comportamiento
  lastOpenedAt  DateTime?
  lastClickedAt DateTime?
  totalOpens    Int       @default(0)
  totalClicks   Int       @default(0)

  // Conversion tracking
  trialStartedAt DateTime?
  convertedAt    DateTime?

  @@index([email])
  @@index([archetype])
  @@index([source])
  @@index([status])
  @@index([engagementScore])
  @@index([currentJourneyStage])
  @@index([subscribedAt])
  @@map("email_subscribers")
}

model HostProfileTest {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  email             String?
  name              String?
  gender            String?
  emailConsent      Boolean  @default(false)
  shareConsent      Boolean  @default(false)
  answers           Json
  scoreHospitalidad Float
  scoreComunicacion Float
  scoreOperativa    Float
  scoreCrisis       Float
  scoreData         Float
  scoreLimites      Float
  scoreMkt          Float
  scoreBalance      Float
  archetype         String
  topStrength       String
  criticalGap       String
  userId            String?
  user              User?    @relation(fields: [userId], references: [id])

  @@index([archetype])
  @@index([email])
  @@index([createdAt])
  @@map("host_profile_tests")
}

model EmailSequence {
  id                   String               @id @default(cuid())
  name                 String
  description          String?
  triggerEvent         String
  targetArchetype      String?
  targetSource         String?
  targetTags           String[]             @default([])
  isActive             Boolean              @default(true)
  priority             Int                  @default(0)
  subscribersEnrolled  Int                  @default(0)
  subscribersCompleted Int                  @default(0)
  subscribersActive    Int                  @default(0)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  steps                EmailSequenceStep[]
  enrollments          SequenceEnrollment[]

  @@index([triggerEvent])
  @@index([isActive])
  @@map("email_sequences")
}

model EmailSequenceStep {
  id                    String           @id @default(cuid())
  sequenceId            String
  name                  String
  subject               String
  templateName          String
  templateData          Json?
  delayDays             Int              @default(0)
  delayHours            Int              @default(0)
  sendAtHour            Int?
  order                 Int              @default(0)
  requiresPreviousOpen  Boolean          @default(false)
  requiresPreviousClick Boolean          @default(false)
  isActive              Boolean          @default(true)
  emailsSent            Int              @default(0)
  emailsDelivered       Int              @default(0)
  emailsOpened          Int              @default(0)
  emailsClicked         Int              @default(0)
  emailsBounced         Int              @default(0)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  sequence              EmailSequence    @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  scheduledEmails       ScheduledEmail[]

  @@index([sequenceId, order])
  @@map("email_sequence_steps")
}

model SequenceEnrollment {
  id               String           @id @default(cuid())
  subscriberId     String
  sequenceId       String
  status           String           @default("active")
  currentStepOrder Int              @default(0)
  enrolledAt       DateTime         @default(now())
  completedAt      DateTime?
  pausedAt         DateTime?
  unsubscribedAt   DateTime?
  emailsSent       Int              @default(0)
  emailsOpened     Int              @default(0)
  emailsClicked    Int              @default(0)
  metadata         Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  scheduledEmails  ScheduledEmail[]
  sequence         EmailSequence    @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, sequenceId])
  @@index([subscriberId])
  @@index([sequenceId, status])
  @@map("sequence_enrollments")
}

model ScheduledEmail {
  id             String             @id @default(cuid())
  enrollmentId   String
  stepId         String
  subscriberId   String
  recipientEmail String
  recipientName  String?
  subject        String
  templateName   String
  templateData   Json?
  scheduledFor   DateTime
  sendAttempts   Int                @default(0)
  status         String             @default("pending")
  sentAt         DateTime?
  deliveredAt    DateTime?
  failedAt       DateTime?
  errorMessage   String?
  resendId       String?            @unique
  openedAt       DateTime?
  clickedAt      DateTime?
  bouncedAt      DateTime?
  complainedAt   DateTime?
  unsubscribedAt DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  enrollment     SequenceEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  step           EmailSequenceStep  @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([status, scheduledFor])
  @@index([subscriberId])
  @@index([enrollmentId])
  @@index([resendId])
  @@map("scheduled_emails")
}

model AdminAuditLog {
  id              String   @id @default(cuid())
  adminId         String
  adminName       String
  adminEmail      String
  targetUserId    String?
  targetUserEmail String?
  targetUserName  String?
  action          String
  propertyId      String?
  propertyName    String?
  zoneId          String?
  zoneName        String?
  metadata        Json?
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())
  admin           Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, createdAt])
  @@index([targetUserId, createdAt])
  @@index([action, createdAt])
  @@index([propertyId, createdAt])
  @@map("admin_audit_logs")
}

enum BlogCategory {
  GUIAS
  MEJORES_PRACTICAS
  NORMATIVA
  AUTOMATIZACION
  MARKETING
  OPERACIONES
  CASOS_ESTUDIO
  NOTICIAS
}

enum BlogStatus {
  DRAFT
  REVIEW
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

enum JourneyStage {
  VISITOR
  LEAD
  REGISTERED
  MQL
  SQL
  CUSTOMER
  CHURNED
}

enum EmailEventType {
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
  UNSUBSCRIBED
}

enum EmailTrigger {
  ON_LEAD_CAPTURE
  ON_REGISTRATION
  ON_TRIAL_START
  ON_SUBSCRIPTION
  ON_INACTIVITY
  ON_CANCELLATION
  MANUAL
}

// FAQ Submissions - user questions
model FaqSubmission {
  id          String              @id @default(cuid())
  question    String              @db.Text
  email       String?
  userId      String?
  status      FaqSubmissionStatus @default(PENDING)
  answer      String?             @db.Text
  category    String?
  isPublished Boolean             @default(false)
  publishedId String? // ID in help-content if published
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  answeredAt  DateTime?
  answeredBy  String?

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt])
  @@map("faq_submissions")
}

enum FaqSubmissionStatus {
  PENDING
  REVIEWING
  ANSWERED
  PUBLISHED
  REJECTED
}

// Email Log - track sent emails for reactivation campaigns
model EmailLog {
  id        String   @id @default(cuid())
  userId    String
  type      String // REACTIVATION_3D, REACTIVATION_7D, REACTIVATION_14D, etc.
  email     String
  subject   String?
  resendId  String? // Resend email ID for tracking
  status    String   @default("SENT") // SENT, DELIVERED, OPENED, CLICKED, etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, type])
  @@index([type, createdAt])
  @@map("email_logs")
}

// Consultation Booking - video call scheduling
model ConsultationBooking {
  id            String    @id @default(cuid())
  email         String
  name          String
  properties    String // 1, 2-3, 4-5, 6-10, 10+
  challenge     String?   @db.Text
  scheduledDate DateTime
  status        String    @default("scheduled") // scheduled, completed, cancelled, no_show
  source        String    @default("direct")
  meetLink      String?
  notes         String?   @db.Text
  adminNotes    String?   @db.Text // Private notes for admin
  metadata      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  completedAt   DateTime?
  leadId        String? // Link to unified lead

  @@index([email])
  @@index([scheduledDate])
  @@index([status])
  @@map("consultation_bookings")
}

// Blocked calendar slots for consultations
model BlockedSlot {
  id        String   @id @default(cuid())
  date      DateTime @db.Date // The date to block
  time      String? // Specific time to block (e.g., "10:00"), null = whole day
  reason    String? // Optional reason for blocking
  createdAt DateTime @default(now())

  @@unique([date, time])
  @@index([date])
  @@map("blocked_slots")
}

// ==========================================
// MÓDULO DE GESTIÓN DE RESERVAS Y FACTURACIÓN
// ==========================================

// Propietarios de propiedades gestionadas
model PropertyOwner {
  id     String @id @default(cuid())
  userId String // Usuario gestor que lo administra

  // Tipo de cliente
  type OwnerType @default(PERSONA_FISICA)

  // Tipo de documento a generar
  // INVOICE = Factura con número fiscal
  // SERVICE_NOTE = Nota de servicios (sin número fiscal)
  // NONE = Solo tracking, no genera documento
  documentType DocumentType @default(INVOICE)

  // Datos fiscales - Persona Física
  firstName String? // Nombre
  lastName  String? // Apellidos
  nif       String? // NIF (8 dígitos + letra) o NIE (X/Y/Z + 7 dígitos + letra)

  // Datos fiscales - Empresa
  companyName String? // Razón social
  cif         String? // CIF (letra + 7 dígitos + control)

  // Dirección fiscal
  address    String
  city       String
  postalCode String
  country    String @default("España")

  // Contacto y pago
  email String
  phone String?
  iban  String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user           User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  billingConfigs PropertyBillingConfig[]
  liquidations   Liquidation[]
  clientInvoices ClientInvoice[]

  @@index([userId])
  @@index([email])
  @@map("property_owners")
}

enum OwnerType {
  PERSONA_FISICA
  EMPRESA
}

enum DocumentType {
  INVOICE // Factura con número fiscal correlativo
  SERVICE_NOTE // Nota de servicios (sin número fiscal, solo referencia interna)
  NONE // Solo tracking interno, no genera documento
}

// Configuración de facturación por propiedad
model PropertyBillingConfig {
  id         String  @id @default(cuid())
  propertyId String  @unique
  ownerId    String? // Propietario (null si es propiedad propia)

  // Nombres de la propiedad en plataformas (para matching automático)
  // Soporta múltiples aliases por plataforma
  airbnbNames  String[] @default([]) // Nombres tal como aparecen en Airbnb
  bookingNames String[] @default([]) // Nombres tal como aparecen en Booking
  vrboNames    String[] @default([]) // Nombres en VRBO/HomeAway

  // ¿Quién recibe el dinero de las reservas?
  incomeReceiver IncomeReceiver @default(OWNER)

  // Comisión de gestión
  commissionType  CommissionType @default(PERCENTAGE)
  commissionValue Decimal        @default(0) // 20 = 20%
  commissionVat   Decimal        @default(21) // 21% IVA

  // Limpieza
  cleaningType         CleaningType         @default(FIXED_PER_RESERVATION)
  cleaningValue        Decimal              @default(0)
  cleaningVatIncluded  Boolean              @default(true)
  cleaningFeeRecipient CleaningFeeRecipient @default(MANAGER) // Quién recibe la limpieza
  cleaningFeeSplitPct  Decimal? // Si es SPLIT, % para el gestor

  // Cargo fijo mensual (opcional)
  monthlyFee        Decimal @default(0)
  monthlyFeeVat     Decimal @default(21)
  monthlyFeeConcept String?

  // Fiscalidad por defecto
  defaultVatRate       Decimal @default(21) // IVA por defecto (21% o 10%)
  defaultRetentionRate Decimal @default(0) // Retención IRPF si aplica

  // Preferencias de factura
  invoiceDetailLevel InvoiceDetailLevel @default(DETAILED)
  singleConceptText  String? // Texto personalizado si invoiceDetailLevel=SUMMARY (ej: "Gestión apartamento turístico")

  // Sync
  icalUrl      String? // URL del calendario iCal
  lastIcalSync DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  property     Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  owner        PropertyOwner?    @relation(fields: [ownerId], references: [id])
  reservations Reservation[]
  expenses     PropertyExpense[]

  @@index([ownerId])
  @@map("property_billing_configs")
}

enum IncomeReceiver {
  OWNER // Propietario recibe dinero → Gestor factura servicios
  MANAGER // Gestor recibe dinero → Gestor transfiere al propietario
}

enum CommissionType {
  PERCENTAGE // Porcentaje del total
  FIXED_PER_RESERVATION // Cantidad fija por reserva
  FIXED_MONTHLY // Cantidad fija mensual
  NONE // Sin comisión
}

enum CleaningType {
  FIXED_PER_RESERVATION // Cantidad fija por reserva
  PER_NIGHT // Por noche
  NONE // Sin limpieza
}

enum CleaningFeeRecipient {
  OWNER // La limpieza va al propietario
  MANAGER // La limpieza va al gestor
  SPLIT // Se reparte según cleaningFeeSplitPct
}

enum InvoiceDetailLevel {
  DETAILED // Con fechas de cada reserva
  SUMMARY // Solo totales agrupados
}

// Reservas importadas (de Airbnb, Booking, etc.)
// ========================================
// HUÉSPEDES (CRM)
// ========================================
model Guest {
  id     String @id @default(cuid())
  userId String // Usuario gestor (cada gestor tiene sus huéspedes)

  // Datos de contacto
  email   String? // Email principal (puede ser null si no se tiene)
  name    String // Nombre completo
  phone   String?
  country String?

  // Notas y observaciones
  notes String? @db.Text // Observaciones internas sobre el huésped

  // Estadísticas (se actualizan automáticamente)
  totalStays  Int       @default(0) // Número total de estancias
  totalSpent  Decimal   @default(0) // Total gastado
  firstStayAt DateTime? // Fecha de primera estancia
  lastStayAt  DateTime? // Fecha de última estancia
  averageStay Float     @default(0) // Promedio de noches por estancia

  // Tags/etiquetas para segmentar
  tags String[] @default([])

  // Preferencias conocidas
  preferences Json? // {earlyCheckIn: true, extraBed: false, etc.}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  reservations Reservation[]

  @@unique([userId, email]) // Email único por gestor (permite null)
  @@index([userId])
  @@index([email])
  @@index([name])
  @@map("guests")
}

model Reservation {
  id              String @id @default(cuid())
  userId          String // Usuario gestor
  billingConfigId String // Configuración de la propiedad

  // Identificación
  platform         ReservationPlatform
  confirmationCode String

  // Huésped (nuevo: referencia a Guest)
  guestId String?

  // Huésped (legacy: campos directos para compatibilidad)
  guestName    String
  guestCountry String?
  guestEmail   String?
  guestPhone   String?
  travelers    Json? // {adults: 2, children: 1, babies: 0}

  // Fechas
  checkIn      DateTime
  checkInTime  String?
  checkOut     DateTime
  checkOutTime String?
  nights       Int

  // Importes
  roomTotal       Decimal // Precio alojamiento
  cleaningFee     Decimal @default(0)
  guestServiceFee Decimal @default(0) // Comisión que paga el huésped a la plataforma
  hostServiceFee  Decimal @default(0) // Comisión que la plataforma te cobra
  hostEarnings    Decimal // Lo que recibes
  currency        String  @default("EUR")

  // Tipo
  type                 ReservationType @default(BOOKING)
  relatedReservationId String? // Para cancelaciones/modificaciones

  // Estado
  status ReservationStatus @default(CONFIRMED)

  // Notas
  guestMessage  String?
  internalNotes String?

  // Fuente del import
  importSource      String? // EMAIL, MANUAL, ICAL, CSV
  importBatchId     String? // ID del batch de importación para rollback
  sourceListingName String? // Nombre original del alojamiento en el CSV (para separar por propiedad más adelante)
  rawEmailData      String? // Email original para debug

  // Unidad (para pensiones/hoteles con múltiples habitaciones)
  unit String? // "Suite Postiguet", "Habitación 101", etc.

  // Liquidación
  liquidationId String?

  // === CAMPOS DE FACTURACIÓN ===
  // Cálculos de reparto (auto-calculados al importar)
  ownerAmount    Decimal? // Lo que corresponde al propietario
  managerAmount  Decimal? // Comisión del gestor
  cleaningAmount Decimal? // Importe limpieza (puede ir a gestor o propietario)

  // Facturación
  invoiced      Boolean @default(false) // ¿Ya está facturada?
  invoiceItemId String? // Línea de factura asociada

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  billingConfig       PropertyBillingConfig @relation(fields: [billingConfigId], references: [id])
  guest               Guest?                @relation(fields: [guestId], references: [id])
  liquidation         Liquidation?          @relation(fields: [liquidationId], references: [id])
  relatedReservation  Reservation?          @relation("ReservationRelation", fields: [relatedReservationId], references: [id])
  relatedReservations Reservation[]         @relation("ReservationRelation")
  invoiceItem         ClientInvoiceItem?    @relation(fields: [invoiceItemId], references: [id])
  payments            ReservationPayment[]

  @@unique([billingConfigId, platform, confirmationCode])
  @@index([userId])
  @@index([billingConfigId])
  @@index([guestId])
  @@index([checkIn])
  @@index([checkOut])
  @@index([status])
  @@index([liquidationId])
  @@index([invoiced])
  @@index([importBatchId])
  @@map("reservations")
}

enum ReservationPlatform {
  AIRBNB
  BOOKING
  VRBO
  DIRECT
  OTHER
}

enum ReservationType {
  BOOKING // Reserva normal
  CANCELLATION // Cancelación
  MODIFICATION // Modificación
  REFUND // Reembolso
}

enum ReservationStatus {
  PENDING // Pendiente de confirmación
  CONFIRMED // Confirmada
  CANCELLED // Cancelada
  COMPLETED // Completada (check-out realizado)
  NO_SHOW // No se presentó
}

// Pagos asociados a reservas (payouts, refunds, resoluciones)
model ReservationPayment {
  id            String @id @default(cuid())
  reservationId String
  userId        String

  // Datos del pago
  paymentDate DateTime
  amount      Decimal // Puede ser negativo (refund)
  currency    String   @default("EUR")

  // Clasificación
  paymentType PaymentType
  category    PaymentCategory?
  description String?

  // Fuente
  source       PaymentSource @default(EMAIL)
  emailId      String? // Si viene de email sincronizado
  rawEmailData String? // Datos del email para debug

  // Decisión de facturación (configurable por usuario)
  billingAction BillingAction @default(NORMAL)

  // Vinculación a factura
  invoiceId     String?
  invoiceLineId String?

  // Control
  autoDetected Boolean @default(true)
  userReviewed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  reservation Reservation    @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoice     ClientInvoice? @relation(fields: [invoiceId], references: [id])

  @@index([reservationId])
  @@index([userId])
  @@index([paymentDate])
  @@index([billingAction])
  @@map("reservation_payments")
}

enum PaymentType {
  PAYOUT // Pago normal de reserva
  REFUND // Reembolso/devolución
  RESOLUTION // Centro de resoluciones
  ADJUSTMENT // Ajuste de Airbnb
  MANUAL // Entrada manual
}

enum PaymentCategory {
  ACCOMMODATION // Alojamiento
  CLEANING // Limpieza extra
  DAMAGE // Daños
  COMPENSATION // Compensación
  OTHER // Otros
}

enum PaymentSource {
  EMAIL // Sincronizado de email
  MANUAL // Entrada manual
  CSV // Importado de CSV
  API // API externa
}

enum BillingAction {
  NORMAL // Incluir con comisión normal
  PASSTHROUGH // Pasar al propietario sin comisión
  MANAGER_KEEPS // 100% para el gestor
  EXCLUDE // No incluir en factura
}

// Gastos por propiedad
model PropertyExpense {
  id              String @id @default(cuid())
  userId          String
  billingConfigId String

  date      DateTime
  concept   String
  category  ExpenseCategory
  amount    Decimal
  vatAmount Decimal         @default(0)

  // Factura adjunta
  invoiceUrl    String?
  invoiceNumber String?
  supplierName  String?
  supplierNif   String?

  // ¿Repercutir al propietario?
  chargeToOwner Boolean @default(true)

  // Liquidación
  liquidationId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  billingConfig PropertyBillingConfig @relation(fields: [billingConfigId], references: [id])
  liquidation   Liquidation?          @relation(fields: [liquidationId], references: [id])

  @@index([userId])
  @@index([billingConfigId])
  @@index([date])
  @@index([liquidationId])
  @@map("property_expenses")
}

enum ExpenseCategory {
  MAINTENANCE // Mantenimiento
  SUPPLIES // Suministros (luz, agua, gas)
  REPAIR // Reparaciones
  CLEANING // Material de limpieza
  FURNITURE // Mobiliario
  TAXES // Impuestos
  INSURANCE // Seguros
  OTHER // Otros
}

// Liquidaciones mensuales
model Liquidation {
  id      String @id @default(cuid())
  userId  String
  ownerId String

  // Período
  year  Int
  month Int

  // Totales calculados
  totalIncome        Decimal // Total reservas
  totalCommission    Decimal // Total comisión
  totalCommissionVat Decimal // IVA de comisión
  totalRetention     Decimal @default(0) // Retención IRPF (15% sobre comisión si persona física)
  totalCleaning      Decimal // Total limpiezas
  totalExpenses      Decimal // Total gastos
  totalAmount        Decimal // Resultado final (a pagar o a transferir)

  // Documento
  status LiquidationStatus @default(DRAFT)
  pdfUrl String?

  // Factura
  invoiceNumber String?
  invoiceDate   DateTime?
  invoiceSeries String?

  // Pago
  paidAt           DateTime?
  paymentMethod    String?
  paymentReference String?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  owner        PropertyOwner     @relation(fields: [ownerId], references: [id])
  reservations Reservation[]
  expenses     PropertyExpense[]

  @@unique([userId, ownerId, year, month])
  @@index([userId])
  @@index([ownerId])
  @@index([status])
  @@map("liquidations")
}

enum LiquidationStatus {
  DRAFT // Borrador
  PENDING // Pendiente de pago
  PAID // Pagada
  CANCELLED // Anulada
}

// Configuración de facturación del gestor
model UserInvoiceConfig {
  id     String @id @default(cuid())
  userId String @unique

  // Datos fiscales del gestor
  businessName String
  nif          String
  address      String
  city         String
  postalCode   String
  country      String @default("España")

  // Contacto
  email String?
  phone String?

  // Personalización
  logoUrl     String?
  footerNotes String?

  // Email inbound para reservas
  inboundEmailToken String @unique @default(cuid())

  // Métodos de cobro
  paymentMethods       Json? // [{type, enabled, details}]
  defaultPaymentMethod String? // PaymentMethodType value

  // Datos bancarios
  bankName String?
  iban     String?
  bic      String?

  // Otros métodos de pago
  bizumPhone  String?
  paypalEmail String?

  // Onboarding tracking
  onboardingSkippedAt      DateTime?
  onboardingCompletedAt    DateTime?
  onboardingReminderSentAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoiceSeries InvoiceSeries[]

  @@map("user_invoice_configs")
}

// Series de facturación (para numeración personalizada)
model InvoiceSeries {
  id              String @id @default(cuid())
  invoiceConfigId String

  name   String // "Facturas 2025", "Serie A", etc.
  prefix String // "A", "B", "2025-"
  year   Int
  type   SeriesType @default(STANDARD) // STANDARD o RECTIFYING

  currentNumber Int     @default(0)
  resetYearly   Boolean @default(true) // Reiniciar numeración cada año
  lastResetYear Int? // Último año en que se reinició

  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  invoiceConfig UserInvoiceConfig @relation(fields: [invoiceConfigId], references: [id], onDelete: Cascade)
  invoices      ClientInvoice[]

  @@unique([invoiceConfigId, prefix, year])
  @@map("invoice_series")
}

// Facturas a clientes (propietarios)
model ClientInvoice {
  id         String  @id @default(cuid())
  userId     String
  ownerId    String
  seriesId   String
  propertyId String? // Propiedad asociada (para facturas por propiedad/mes)

  // Período de facturación
  periodMonth Int? // 1-12
  periodYear  Int? // 2026

  // Numeración (null hasta que se emita)
  number     Int? // Número secuencial dentro de la serie
  fullNumber String? // "A-2025-00001"

  // Fechas
  issueDate DateTime
  dueDate   DateTime?
  issuedAt  DateTime? // Momento exacto de emisión (cuando se asigna número)

  // Totales
  subtotal        Decimal
  totalVat        Decimal
  retentionRate   Decimal @default(0) // Porcentaje de retención IRPF (0, 7, 15, 19)
  retentionAmount Decimal @default(0) // Importe de retención
  total           Decimal

  // Estado e inmutabilidad
  status   ClientInvoiceStatus @default(DRAFT)
  isLocked Boolean             @default(false) // true después de emitir

  // Rectificativa
  isRectifying     Boolean         @default(false)
  rectifyingType   RectifyingType? // SUBSTITUTION o DIFFERENCE
  rectifiesId      String? // Factura original que rectifica
  rectifyingReason String?
  originalTotal    Decimal? // Total original (para rectificativas por diferencias)

  // Método de cobro usado
  paymentMethodUsed String? // PaymentMethodType value

  // PDF
  pdfUrl String?

  // Acceso público (para envío por email)
  publicToken  String?   @unique // Token único para ver factura sin login
  sentAt       DateTime? // Cuándo se envió por email
  sentTo       String? // Email al que se envió
  emailSubject String? // Asunto del email
  emailBody    String? // Cuerpo del email

  // Notas
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  owner       PropertyOwner        @relation(fields: [ownerId], references: [id])
  series      InvoiceSeries        @relation(fields: [seriesId], references: [id])
  property    Property?            @relation(fields: [propertyId], references: [id])
  rectifies   ClientInvoice?       @relation("InvoiceRectification", fields: [rectifiesId], references: [id])
  rectifiedBy ClientInvoice[]      @relation("InvoiceRectification")
  items       ClientInvoiceItem[]
  payments    ReservationPayment[] // Pagos incluidos en esta factura

  @@unique([seriesId, number])
  @@index([userId])
  @@index([ownerId])
  @@index([propertyId])
  @@index([status])
  @@index([issueDate])
  @@index([ownerId, issueDate])
  @@map("client_invoices")
}

enum ClientInvoiceStatus {
  DRAFT // Borrador editable
  PROFORMA // Presupuesto/proforma (sin validez fiscal)
  ISSUED // Emitida con número fiscal
  SENT // Enviada al cliente
  PAID // Pagada
  OVERDUE // Vencida
}

// Tipo de factura rectificativa
enum RectifyingType {
  SUBSTITUTION // Anula y reemplaza completamente
  DIFFERENCE // Solo ajusta importes
}

// Tipo de serie de facturación
enum SeriesType {
  STANDARD // Facturas normales (F, A)
  RECTIFYING // Facturas rectificativas (R, FR)
}

// Métodos de pago
enum PaymentMethodType {
  TRANSFER // Transferencia bancaria
  DIRECT_DEBIT // Domiciliación SEPA
  CASH // Efectivo
  CARD // Tarjeta
  BIZUM // Bizum
  PAYPAL // PayPal
}

// Líneas de factura
model ClientInvoiceItem {
  id        String @id @default(cuid())
  invoiceId String

  concept       String
  description   String? // Descripción adicional debajo del concepto
  quantity      Decimal @default(1)
  unitPrice     Decimal
  vatRate       Decimal @default(21)
  retentionRate Decimal @default(0) // IRPF retention percentage per line
  total         Decimal

  // Vinculación con reserva (opcional)
  reservationId String?
  periodStart   DateTime? // Fecha inicio del período (para líneas agrupadas)
  periodEnd     DateTime? // Fecha fin del período

  // Orden de visualización
  order Int @default(0)

  createdAt DateTime @default(now())

  // Relaciones
  invoice      ClientInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  reservations Reservation[] // Reservas vinculadas a esta línea

  @@index([invoiceId])
  @@index([reservationId])
  @@map("client_invoice_items")
}

// Log de importaciones de reservas (Airbnb CSV, etc.)
model ReservationImport {
  id            String   @id @default(cuid())
  userId        String
  fileName      String
  source        String   @default("AIRBNB") // AIRBNB, BOOKING, MANUAL
  importDate    DateTime @default(now())
  totalRows     Int
  importedCount Int      @default(0)
  skippedCount  Int      @default(0)
  errorCount    Int      @default(0)
  errors        Json? // [{row, error}]
  propertyId    String? // Propiedad asociada (opcional)
  importBatchId String?  @unique // ID del batch para vincular con reservas importadas
  listingsFound Json? // Lista de nombres de alojamiento encontrados en el CSV

  createdAt DateTime @default(now())

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([importDate])
  @@index([importBatchId])
  @@map("reservation_imports")
}

// Plantillas de importación guardadas por usuario
model ImportTemplate {
  id     String @id @default(cuid())
  userId String
  name   String

  // Mapeo de columnas (índices en el CSV)
  guestNameColumn        Int
  checkInColumn          Int
  checkOutColumn         Int
  amountColumn           Int // hostEarnings o roomTotal según amountType
  confirmationCodeColumn Int?
  nightsColumn           Int?
  cleaningFeeColumn      Int?
  commissionColumn       Int?
  statusColumn           Int?

  // Configuración de parsing
  dateFormat   String @default("DD/MM/YYYY") // DD/MM/YYYY, MM/DD/YYYY, YYYY-MM-DD, DD-MM-YYYY
  numberFormat String @default("EU") // EU: 1.234,56 | US: 1,234.56
  amountType   String @default("NET") // NET: hostEarnings | GROSS: roomTotal
  platform     String @default("OTHER") // AIRBNB, BOOKING, VRBO, DIRECT, OTHER

  // Headers originales (para reconocimiento futuro)
  originalHeaders Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@map("import_templates")
}

// ==========================================
// GMAIL INTEGRATION - Auto-import reservations
// ==========================================

model GmailIntegration {
  id           String    @id @default(cuid())
  userId       String    @unique
  email        String // Gmail account email
  accessToken  String    @db.Text
  refreshToken String    @db.Text
  tokenExpiry  DateTime
  isActive     Boolean   @default(true)
  lastSyncAt   DateTime?
  syncErrors   Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  syncedEmails GmailSyncedEmail[]

  @@map("gmail_integrations")
}

model GmailSyncedEmail {
  id                 String   @id @default(cuid())
  gmailIntegrationId String
  messageId          String // Gmail message ID (para evitar duplicados)
  threadId           String?
  subject            String?
  fromEmail          String
  receivedAt         DateTime
  emailType          String // RESERVATION_CONFIRMED, PAYOUT_SENT, etc.

  // Datos extraídos
  parsedData Json? // {confirmationCode, guestName, checkIn, etc.}

  // Estado
  status        String  @default("PENDING") // PENDING, PROCESSED, SKIPPED, ERROR
  errorMessage  String?
  reservationId String? // Si se creó una reserva

  createdAt DateTime @default(now())

  // Relaciones
  gmailIntegration GmailIntegration @relation(fields: [gmailIntegrationId], references: [id], onDelete: Cascade)

  @@unique([gmailIntegrationId, messageId])
  @@index([gmailIntegrationId, status])
  @@index([receivedAt])
  @@map("gmail_synced_emails")
}
